
Array.prototype.getElementByPropertyValue=function(property,value){return this[this.getKeyByPropertyValue(property,value)];};Array.prototype.getArrayByPropertyValue=function(property,value){return this.filter(function(arr){return arr[property]===value;});};Array.prototype.getKeyByPropertyValue=function(property,value){var i;for(i=0;i<this.length;i++){if(this[i][property]===value){return i;}}
return false;};Array.prototype.getKeysByPropertyValue=function(property,value){var i,keys;keys=[];for(i=0;i<this.length;i++){if(this[i][property]===value){keys.push(i);}}
return keys;};Array.prototype.getArrayFromProperty=function(property){var i,array;array=[];for(i=0;i<this.length;i++){this[i][property]&&array.push(this[i][property]);}
return array;};Array.prototype.sortByNumericProperty=function(property,desc){var sortedArray=[],copy=[],currentID,currentVal,i;Array.prototype.push.apply(copy,this);while(copy.length){currentVal=false;for(i=0;i<copy.length;i++){if(!desc){if(copy[i][property]<currentVal||currentVal===false){currentID=i;currentVal=copy[i][property];}}
else{if(copy[i][property]>currentVal||currentVal===false){currentID=i;currentVal=copy[i][property];}}}
sortedArray.push(copy.splice(currentID,1)[0]);}
return sortedArray;};Object.prototype.importProperties=function(from,copyIfPossible){var i;for(i in from){if(from.hasOwnProperty(i)){if(i===undefined){continue;}
if(!copyIfPossible||typeof from[i]!=='object'){this[i]=from[i];}
else{if(from[i].copy){this[i]=from[i].copy();}
else if(from[i].clone){this[i]=from[i].clone();}
else{this[i]=from[i];}}}}};Object.prototype.implements=function(checkClass){return(checkClass.prototype.isPrototypeOf(this)?true:this.inherits(checkClass));};Object.prototype.inherits=function(checkClass){if(this.inheritedClasses){return this.inheritedClasses.indexOf(checkClass)!==-1;}
return false;};if(!window.requestAnimationFrame){window.requestAnimationFrame=(function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1000/60);};})();}
Array.prototype.forEach=function(func){var cp;cp=[];cp.push.apply(cp,this);for(var i=0;i<cp.length;i++){func.call(cp[i],i);}};function Class(className,inherits,functions){var name,constructor,str,i,ii,inheritClass,newClass,propName;name=className.split('.');constructor=name[name.length-1];for(i=0;i<name.length-1;i++){str=name.slice(0,i-1).join('.');if(eval('window.'+str)===undefined){eval(str+' = {}');}}
if(inherits!==undefined&&!Array.prototype.isPrototypeOf(inherits)&&inherits.prototype===undefined){functions=inherits;inherits=undefined;}
eval('\
    '+className+' = function () {\
        this.'+name[name.length-1]+'.apply(this, arguments);\
    }');newClass=eval('window.'+className);newClass.prototype[constructor]=function(){};newClass.prototype.className=className;newClass.prototype.inheritedClasses=[];function inherit(newClass,inheritClass){var functionName;newClass.prototype.inheritedClasses.push(inheritClass);Array.prototype.push.apply(newClass.prototype.inheritedClasses,inheritClass.prototype.inheritedClasses);for(functionName in inheritClass.prototype){if(inheritClass.prototype.hasOwnProperty(functionName)){if(typeof inheritClass.prototype[functionName]==="function"){newClass.prototype[functionName]=inheritClass.prototype[functionName];}}}}
if(inherits){for(i=0;i<inherits.length;i++){inheritClass=inherits[i];inherit(newClass,inheritClass);}}
for(propName in functions){if(functions.hasOwnProperty(propName)){newClass.prototype[propName]=functions[propName];}}};KEY_LEFT=37;KEY_UP=38;KEY_RIGHT=39;KEY_DOWN=40;KEY_SPACE=32;KEY_BACKSPACE=8;KEY_TAB=9;KEY_ENTER=13;KEY_SHIFT=16;KEY_CONTROL=17;KEY_ALT_LEFT=18;KEY_CAPSLOCK=20;KEY_ESCAPE=27;KEY_ALT_RIGHT=0;KEY_F1=112;KEY_F2=113;KEY_F3=114;KEY_F4=115;KEY_F5=116;KEY_F6=117;KEY_F7=118;KEY_F8=119;KEY_F9=120;KEY_F10=121;KEY_F11=122;KEY_F12=123;MOUSE_ANY=0;MOUSE_1=1;MOUSE_2=2;MOUSE_3=3;MOUSE_4=4;MOUSE_5=5;MOUSE_6=6;MOUSE_7=7;MOUSE_8=8;MOUSE_9=9;MOUSE_10=10;TOUCH_ANY=20;TOUCH_1=21;TOUCH_2=22;TOUCH_3=23;TOUCH_4=24;TOUCH_5=25;TOUCH_6=26;TOUCH_7=27;TOUCH_8=28;TOUCH_9=29;TOUCH_10=30;MOUSE_TOUCH_ANY=100;SPEED_PIXELS_PER_SECOND=1;SPEED_PIXELS_PER_FRAME=2;OFFSET_TOP_LEFT='tl';OFFSET_TOP_CENTER='tc';OFFSET_TOP_RIGHT='tr';OFFSET_MIDDLE_LEFT='ml';OFFSET_MIDDLE_CENTER='mc';OFFSET_MIDDLE_RIGHT='mr';OFFSET_BOTTOM_LEFT='bl';OFFSET_BOTTOM_CENTER='bc';OFFSET_BOTTOM_RIGHT='br';ALIGNMENT_LEFT='left';ALIGNMENT_CENTER='center';ALIGNMENT_RIGHT='right';(function(){function slideOut(camera,from,animOptions){switch(from){case'left':camera.projectionRegion.animate({x:camera.projectionRegion.x+engine.canvasResX},animOptions);break;case'right':camera.projectionRegion.animate({x:camera.projectionRegion.x-engine.canvasResX},animOptions);break;case'top':camera.projectionRegion.animate({y:camera.projectionRegion.y+engine.canvasResY},animOptions);break;case'bottom':camera.projectionRegion.animate({y:camera.projectionRegion.y-engine.canvasResY},animOptions);break;}}
function slideIn(camera,from,animOptions){switch(from){case'left':camera.projectionRegion.x-=engine.canvasResX;camera.projectionRegion.animate({x:camera.projectionRegion.x+engine.canvasResX},animOptions);break;case'right':camera.projectionRegion.x+=engine.canvasResX;camera.projectionRegion.animate({x:camera.projectionRegion.x-engine.canvasResX},animOptions);break;case'top':camera.projectionRegion.y-=engine.canvasResY;camera.projectionRegion.animate({y:camera.projectionRegion.y+engine.canvasResY},animOptions);break;case'bottom':camera.projectionRegion.y+=engine.canvasResY;camera.projectionRegion.animate({y:camera.projectionRegion.y-engine.canvasResY},animOptions);break;}}
function squeezeOut(camera,from,animOptions){switch(from){case'left':camera.projectionRegion.animate({width:0,x:camera.projectionRegion.x+engine.canvasResX},animOptions);break;case'right':camera.projectionRegion.animate({width:0},animOptions);break;case'top':camera.projectionRegion.animate({height:0,y:camera.projectionRegion.y+engine.canvasResY},animOptions);break;case'bottom':camera.projectionRegion.animate({height:0},animOptions);break;}}
function squeezeIn(camera,from,animOptions){var oldWidth,oldHeight;switch(from){case'left':oldWidth=camera.projectionRegion.width;camera.projectionRegion.width=0;camera.projectionRegion.animate({width:oldWidth},animOptions);break;case'right':oldWidth=camera.projectionRegion.width;camera.projectionRegion.width=0;camera.projectionRegion.x+=engine.canvasResX;camera.projectionRegion.animate({x:camera.projectionRegion.x-engine.canvasResX,width:oldWidth},animOptions);break;case'top':oldHeight=camera.projectionRegion.height;camera.projectionRegion.height=0;camera.projectionRegion.animate({height:oldHeight},animOptions);break;case'bottom':oldHeight=camera.projectionRegion.height;camera.projectionRegion.height=0;camera.projectionRegion.y+=engine.canvasResY;camera.projectionRegion.animate({y:camera.projectionRegion.y-engine.canvasResY,height:oldHeight},animOptions);break;}}
ROOM_TRANSITION_NONE=function(oldRoom,newRoom,options,callback){var i,camera;for(i=0;i<engine.cameras.length;i++){camera=engine.cameras[i];if(camera.room===oldRoom){camera.room=newRoom;}}
callback();}
ROOM_TRANSITION_SLIDE_SLIDE=function(oldRoom,newRoom,options,callback){var i,camera,newCams,newCam,animOptions;newCams=[];oldRoom.pause();options=options||{};options.from=options.from||'right';animOptions={easing:options.easing||'quadInOut',duration:options.duration||2000,loop:engine.masterRoom.loops.eachFrame,}
for(i=0;i<engine.cameras.length;i++){camera=engine.cameras[i];if(camera.room===oldRoom){slideOut(camera,options.from,animOptions);newCam=new Engine.Camera(camera.captureRegion.copy(),camera.projectionRegion.copy(),newRoom);newCams.push(newCam);}}
engine.cameras.push.apply(engine.cameras,newCams);newCams.forEach(function(){slideIn(this,options.from,animOptions);});engine.masterRoom.loops.eachFrame.schedule(oldRoom,function(){this.play();engine.cameras=engine.cameras.filter(function(camera){return newCams.indexOf(camera)!==-1;})
callback();},animOptions.duration);}
ROOM_TRANSITION_SQUEEZE_SLIDE=function(oldRoom,newRoom,options,callback){var i,camera,newCams,newCam,animOptions;newCams=[];oldRoom.pause();options=options||{};options.from=options.from||'right';animOptions={easing:options.easing||'quadInOut',duration:options.duration||2000,loop:engine.masterRoom.loops.eachFrame,}
for(i=0;i<engine.cameras.length;i++){camera=engine.cameras[i];if(camera.room===oldRoom){squeezeOut(camera,options.from,animOptions);newCam=new Engine.Camera(camera.captureRegion.copy(),camera.projectionRegion.copy(),newRoom);newCams.push(newCam);}}
engine.cameras.push.apply(engine.cameras,newCams);newCams.forEach(function(){slideIn(this,options.from,animOptions);});engine.masterRoom.loops.eachFrame.schedule(oldRoom,function(){this.play();engine.cameras=engine.cameras.filter(function(camera){return newCams.indexOf(camera)!==-1;})
callback();},animOptions.duration);}
ROOM_TRANSITION_SQUEEZE_SQUEEZE=function(oldRoom,newRoom,options,callback){var i,camera,newCams,newCam,animOptions;newCams=[];oldRoom.pause();options=options||{};options.from=options.from||'right';animOptions={easing:options.easing||'quadInOut',duration:options.duration||2000,loop:engine.masterRoom.loops.eachFrame,};for(i=0;i<engine.cameras.length;i++){camera=engine.cameras[i];if(camera.room===oldRoom){squeezeOut(camera,options.from,animOptions);newCam=new Engine.Camera(camera.captureRegion.copy(),camera.projectionRegion.copy(),newRoom);newCams.push(newCam);}}
engine.cameras.push.apply(engine.cameras,newCams);newCams.forEach(function(){squeezeIn(this,options.from,animOptions);});engine.masterRoom.loops.eachFrame.schedule(oldRoom,function(){this.play();engine.cameras=engine.cameras.filter(function(camera){return newCams.indexOf(camera)!==-1;})
callback();},animOptions.duration);}
ROOM_TRANSITION_SLIDE_SQUEEZE=function(oldRoom,newRoom,options,callback){var i,camera,newCams,newCam,animOptions;newCams=[];oldRoom.pause();options=options||{};options.from=options.from||'right';animOptions={easing:options.easing||'quadInOut',duration:options.duration||2000,loop:engine.masterRoom.loops.eachFrame,};for(i=0;i<engine.cameras.length;i++){camera=engine.cameras[i];if(camera.room===oldRoom){slideOut(camera,options.from,animOptions);newCam=new Engine.Camera(camera.captureRegion.copy(),camera.projectionRegion.copy(),newRoom);newCams.push(newCam);}}
engine.cameras.push.apply(engine.cameras,newCams);newCams.forEach(function(){squeezeIn(this,options.from,animOptions);});engine.masterRoom.loops.eachFrame.schedule(oldRoom,function(){this.play();engine.cameras=engine.cameras.filter(function(camera){return newCams.indexOf(camera)!==-1;})
callback();},animOptions.duration);}})();(function(){new Class('Engine',{Engine:function(options){engine=this;this.options=options?options:{};this.load();},load:function(){var copyOpt,audioFormats,i,opt;this.host={hasTouch:'ontouchstart'in document,hasMouse:false,browserEngine:'Unknown',device:'Unknown',supportedAudio:[]};if(navigator.userAgent.match(/Firefox/)){this.host.browserEngine='Gecko';}else if(navigator.userAgent.match(/AppleWebKit/)){this.host.browserEngine='WebKit';if(navigator.userAgent.match(/iPad|iPhone/)){this.host.device='iDevice';}else if(navigator.userAgent.match(/Android/)){this.host.device='Android';}}else if(navigator.userAgent.match(/Trident/)){this.host.browserEngine='Trident';}
audioFormats=['mp3','ogg','wav'];for(i=0;i<audioFormats.length;i++){if(document.createElement('audio').canPlayType('audio/'+audioFormats[i])){this.host.supportedAudio.push(audioFormats[i]);}}
this.avoidSubPixelRendering=true;this.preloadSounds=true;switch(this.host.device){case'iDevice':this.preloadSounds=false;break;}
this.running=false;this.canvasResX=800;this.canvasResY=600;this.enginePath='js/jsEngine';this.focusOnLoad=true;this.themesPath='themes';this.drawBoundingBoxes=false;this.drawMasks=false;this.pauseOnBlur=true;this.disableRightClick=true;this.preventDefaultKeyboard=false;this.arena=document.getElementById('arena');this.autoResize=true;this.autoResizeLimitToResolution=true;this.cachedSoundCopies=5;this.gameClassPath="js/Game.js";this.loadText="jsEngine loading...";this.backgroundColor="#000";this.timeFactor=1;this.disableTouchScroll=true;this.resetCursorOnEachFrame=true;this.cameras=[];this.defaultCollisionResolution=6;this.redrawObjects=[];this.enableRedrawRegions=false;this.disableWebGL=false;this.soundsMuted=false;this.musicMuted=false;copyOpt=['arena','autoResize','autoResizeLimitToResolution','avoidSubPixelRendering','backgroundColor','cachedSoundCopies','canvasResX','canvasResY','defaultCollisionResolution','disableWebGL','disableRightClick','disableTouchScroll','drawBoundingBoxes','drawMasks','enableRedrawRegions','enginePath','focusOnLoad','gameClassPath','loadText','musicMuted','pauseOnBlur','preventDefaultKeyboard','resetCursorOnEachFrame','soundsMuted','themesPath',];for(i=0;i<copyOpt.length;i++){opt=copyOpt[i];if(this.options[opt]!==undefined){this[opt]=this.options[opt];delete this.options[opt];}}
this.arena.style.position="absolute";this.arena.style.backgroundColor="#000";this.arena.style.userSelect="none";this.arena.style.webkitUserSelect="none";this.arena.style.MozUserSelect="none";this.createCanvas();this.initRenderer();if(this.autoResize){this.autoResize=false;this.setAutoResize(true);}
else{this.autoResize=true;this.setAutoResize(false);}
if(this.disableTouchScroll){document.addEventListener('touchmove',function(event){event.preventDefault();},false);document.addEventListener('touchstart',function(event){event.preventDefault();},false);}
loader=new Engine.Loader();loader.loadClasses([this.gameClassPath]);this.gameClassName=this.gameClassPath.match(/(\w*)\.\w+$/)[1];this.defaultTheme=this.options.themes[0];loader.onthemesloaded=function(){engine.initialize();};loader.loadThemes(this.options.themes);},initialize:function(){var objectName;this.objectIndex={};this.frames=0;this.last=new Date().getTime();this.now=this.last;this.gameTime=0;this.currentId=0;this.fps=0;this.fpsCounter=0;this.drawTime=0;this.drawTimeCounter=0;this.drawCalls=0;this.roomList=[];this.masterRoom=new Engine.Room('master');this.currentRoom=new Engine.Room('main');this.defaultAnimationLoop=this.currentRoom.loops.eachFrame;this.defaultActivityLoop=this.currentRoom.loops.eachFrame;this.cameras.push(new Engine.Camera(new Math.Rectangle(0,0,this.canvasResX,this.canvasResY),new Math.Rectangle(0,0,this.canvasResX,this.canvasResY)));if(this.disableRightClick){this.arena.oncontextmenu=function(){return false;};}
keyboard=new Input.Keyboard();pointer=new Input.Pointer();if(this.pauseOnBlur){window.addEventListener('blur',function(){engine.stopMainLoop();});window.addEventListener('focus',function(){engine.startMainLoop();});}
if(window[this.gameClassName]!=="undefined"){objectName=this.gameClassName.substr(0,1).toLowerCase()+this.gameClassName.substr(1);eval(objectName+" = new "+this.gameClassName+'()');}
else{;loader.hideOverlay();}
this.startMainLoop();if(this.focusOnLoad){window.focus();}
if(this.onload){this.onload();}},createCanvas:function(){var gl;this.canvas=document.createElement("canvas");this.canvas.style.display="block";this.canvas.width=this.canvasResX;this.canvas.height=this.canvasResY;this.arena.appendChild(this.canvas);},initRenderer:function(){if(!this.disableWebGL&&(this.canvas.getContext('webgl')||this.canvas.getContext('experimental-webgl'))){this.renderer=new Renderer.WebGL(this.canvas);}
else{this.renderer=new Renderer.Canvas(this.canvas);}},setAutoResize:function(enable){if(enable&&!this.autoResize){this.autoResize=true;this.autoResizeCanvas();window.addEventListener('resize',engine.autoResizeCanvas,false);window.addEventListener('load',engine.autoResizeCanvas,false);}
else if(!enable&&this.autoResize){this.autoResize=false;window.removeEventListener('resize',engine.autoResizeCanvas,false);window.removeEventListener('load',engine.autoResizeCanvas,false);this.arena.style.top="50%";this.arena.style.left="50%";this.arena.style.marginLeft=-this.canvasResX/2+"px";this.arena.style.marginTop=-this.canvasResY/2+"px";this.canvas.style.width=this.canvasResX+"px";this.canvas.style.height=this.canvasResY+"px";}},autoResizeCanvas:function(){if(this!==engine){engine.autoResizeCanvas();return;}
var h,w,windowWH,gameWH;windowWH=window.innerWidth/window.innerHeight;gameWH=this.canvasResX/this.canvasResY;if(windowWH>gameWH){h=window.innerHeight;w=this.canvasResX/this.canvasResY*h;}else{w=window.innerWidth;h=this.canvasResY/this.canvasResX*w;}
if(this.autoResizeLimitToResolution){w=Math.min(w,this.canvasResX);h=Math.min(h,this.canvasResY);}
this.arena.style.top="50%";this.arena.style.left="50%";this.arena.style.marginTop=-h/2+"px";this.arena.style.marginLeft=-w/2+"px";this.canvas.style.height=h+"px";this.canvas.style.width=w+"px";},convertSpeed:function(speed,from,to){if(speed.implements(Math.Vector)){return new Math.Vector(this.convertSpeed(speed.x,from,to),this.convertSpeed(speed.y,from,to));}
from=from!==undefined?from:SPEED_PIXELS_PER_SECOND;to=to!==undefined?to:SPEED_PIXELS_PER_FRAME;switch(from){case SPEED_PIXELS_PER_SECOND:speed=speed*this.gameTimeIncrease/1000;break;case SPEED_PIXELS_PER_FRAME:break;}
switch(to){case SPEED_PIXELS_PER_SECOND:speed=speed/this.gameTimeIncrease*1000;break;case SPEED_PIXELS_PER_FRAME:break;}
return speed;},goToRoom:function(room,transition,transitionOptions){var oldRoom;if(this.changingRoom){return false;}
if(typeof room==="string"){room=this.roomList.getElementByPropertyValue('name',room);}
else{if(this.roomList.indexOf(room)===-1){}}
transition=transition?transition:ROOM_TRANSITION_NONE;oldRoom=this.currentRoom;engine.changingRoom=true;transition(oldRoom,room,transitionOptions,function(){engine.changingRoom=false;engine.currentRoom=room;});return oldRoom;},addRoom:function(room){this.roomList.push(room);},removeRoom:function(room){var index;if(typeof room==="string"){room=this.roomList.getElementByPropertyValue('name',room);}
index=this.roomList.indexOf(room);if(index===-1){}
if(room===this.masterRoom){}
else if(room===this.currentRoom){}
this.roomList.splice(i,1);},setSoundsMuted:function(muted){muted=muted!==undefined?muted:true;if(muted){loader.getAllSounds().forEach(function(){this.stopAll();});}
this.soundsMuted=muted;},setMusicMuted:function(muted){muted=muted!==undefined?muted:true;if(muted){loader.getAllMusic().forEach(function(){this.stop();});}
this.musicMuted=muted;},setDefaultTheme:function(themeName,enforce){enforce=enforce!==undefined?enforce:false;this.defaultTheme=themeName;this.currentRoom.setTheme(undefined,enforce);},startMainLoop:function(){if(this.running){return;}
this.now=new Date().getTime();this.running=true;engine.mainLoop();},stopMainLoop:function(){if(!this.running){return;}
this.running=false;},mainLoop:function(){if(!this.running){return;}
var drawTime;this.last=this.now;this.now=new Date().getTime();this.timeIncrease=this.now-this.last;this.gameTimeIncrease=this.timeIncrease*this.timeFactor;this.gameTime+=this.gameTimeIncrease;this.frames++;if(this.resetCursorOnEachFrame){pointer.resetCursor();}
this.masterRoom.update();this.currentRoom.update();this.redraw();requestAnimationFrame(function(time){engine.mainLoop(time);});},setCanvasResX:function(res){this.canvas.width=res;this.canvasResX=res;if(this.autoResize){this.autoResizeCanvas();}},setCanvasResY:function(res){this.canvas.height=res;this.canvasResY=res;if(this.autoResize){this.autoResizeCanvas();}},registerObject:function(obj,id){if(id===undefined){this.currentId++;id="obj"+(this.currentId-1);}
this.objectIndex[id]=obj;obj.id=id;return id;},loadFileContent:function(filePath){req=new XMLHttpRequest();req.open('GET',filePath,false);req.send();return req.responseText;},loadFiles:function(filePaths){var i,req,codeString;if(typeof filePaths==="string"){filePaths=[filePaths];}
for(i=0;i<filePaths.length;i++){codeString=this.loadFileContent(filePaths[i])+"\n//# sourceURL=/"+filePaths[i];eval(codeString);}
if(window.loadedFiles===undefined){window.loadedFiles=[];}
window.loadedFiles=window.loadedFiles.concat(filePaths);},ajaxRequest:function(url,params,async,callback,caller){params=params!==undefined?params:'';async=async!==undefined?async:true;caller=caller!==undefined?caller:window;if(typeof params!=='string'){params='data='+JSON.stringify(params);}
var req;req=new XMLHttpRequest();if(async){req.onreadystatechange=function(){if(req.readyState===4&&req.status===200){callback.call(caller,req.responseText);}};}
req.open('POST',url,async);req.setRequestHeader("Content-type","application/x-www-form-urlencoded");req.send(params);if(!async){callback.call(caller,req.responseText);}},purge:function(obj){var len,name,loop,roomId,room;if(typeof obj==="string"){obj=this.objectIndex[obj];}
if(obj.children){len=obj.children.length;while(len--){engine.purge(obj.children[len]);}}
for(roomId=0;roomId<this.roomList.length;roomId++){room=this.roomList[roomId];for(name in room.loops){if(room.loops.hasOwnProperty(name)){loop=room.loops[name];loop.detachFunctionsByCaller(obj);loop.unscheduleByCaller(obj);loop.removeAnimationsOfObject(obj);}}}
if(obj.parent){obj.parent.removeChildren(obj);}
delete this.objectIndex[obj.id];},redraw:function(){this.renderer.render(this.cameras);},dumpScreen:function(){var dataString,a;dataString=this.canvas.toDataURL().replace(/image\/png/,'image/octet-stream');a=document.createElement('a');a.href=dataString;a.setAttribute('download','screendump.png');document.body.appendChild(a);a.click();document.body.removeChild(a,document.body);},ease:function(type,t,b,c,d){var a;switch(type){case"linear":t/=d;return b+c*t;case"quadIn":t/=d;return b+c*t*t;case"quadOut":t/=d;return b-c*t*(t-2);case"quadInOut":t=t/d*2;if(t<1){return b+c*t*t/2;}else{t--;return b+c*(1-t*(t-2))/2;}
case"powerIn":t/=d;a=c/Math.abs(c);return b+a*Math.pow(Math.abs(c),t);case"powerOut":t/=d;a=c/Math.abs(c);return b+c-a*Math.pow(Math.abs(c),1-t);case"powerInOut":t=t/d*2;a=c/Math.abs(c);if(t<1){return b+a*Math.pow(Math.abs(c),t)/2;}else{t--;return b+c-a*Math.pow(Math.abs(c),1-t)/2;}
case"sinusInOut":t/=d;return b+c*(1+Math.cos(Math.PI*(1+t)))/2;}
return b+c;}});}());new Class('Engine.Loader',{Loader:function(){this.images={};this.loaded={classes:[]};this.themes={External:{"name":"External","inherit":[],"music":{},"sfx":{},"images":{},"masks":{},"textures":{},"resourcesCount":0,"resourcesLoaded":0}};this.loadOverlay=document.createElement('div');this.loadOverlay.setAttribute('style','border: 0;position: absolute;top: 0;left: 0;width: 100%;height: 100%;z-index: 100;opacity: 1;');this.loadOverlay.id="loadOverlay";this.loadOverlay.innerHTML='<div id="loadOverlayText">'+engine.loadText+'</div>';engine.arena.appendChild(this.loadOverlay);},hideOverlay:function(callback){this.fadeCallback=callback;this.fadeOpacity=1;this.fade=function(){var obj=loader.loadOverlay;loader.fadeOpacity=Math.max(0,loader.fadeOpacity-0.1);loader.fadeOpacity=Math.floor(loader.fadeOpacity*100)/100;obj.style.opacity=loader.fadeOpacity;if(loader.fadeOpacity!==0){setTimeout(function(){loader.fade();},30);}
else{engine.arena.removeChild(loader.loadOverlay);delete loader.fade;if(loader.fadeCallback){loader.fadeCallback();}
delete loader.fadeCallback;}};this.fade();},getImage:function(resource,themeName){themeName=themeName!==undefined?themeName:engine.defaultTheme;return this.getResource(resource,'images',themeName);},getSound:function(resource,themeName){themeName=themeName!==undefined?themeName:engine.defaultTheme;return this.getResource(resource,'sfx',themeName);},getMusic:function(resource,themeName){themeName=themeName!==undefined?themeName:engine.defaultTheme;return this.getResource(resource,'music',themeName);},getMask:function(resource,themeName){themeName=themeName!==undefined?themeName:engine.defaultTheme;var mask;mask=this.getResource(resource,'masks',themeName);if(mask){return mask;}
else{mask=this.generateMask(resource);this.themes[themeName].masks[resource]=mask;return mask;}},getResource:function(resource,typeString,themeName){var res,inh,i;if(resource.indexOf('/')!==-1){resource=resource.replace(/\//g,'.');}
res=this.themes[themeName][typeString][resource];if(res===undefined){for(i=0;i<this.themes[themeName].inherit.length;i++){inh=this.themes[themeName].inherit[i];if(this.themes[inh]){res=this.themes[inh][typeString][resource];if(res){break;}}}}
return res===undefined?false:res;},getImageSources:function(){var object,sourceStrings,currentDir,loopThrough,inheritTheme,i;object=this.themes[engine.defaultTheme].images;sourceStrings=[];currentDir=[];loopThrough=function(object){var pushStr,name;if(object.src!==undefined){pushStr=currentDir.join('.');if(sourceStrings.indexOf(pushStr)===-1){sourceStrings.push(pushStr);}}
else{for(name in object){if(object.hasOwnProperty(name)){currentDir.push(name);loopThrough(object[name]);currentDir.pop();}}}};loopThrough(object);for(i=0;i<this.themes[engine.defaultTheme].inherit.length;i++){inheritTheme=this.themes[this.themes[engine.defaultTheme].inherit[i]];if(inheritTheme!==undefined&&inheritTheme.images!==undefined){loopThrough(inheritTheme.images);}}
return sourceStrings;},getAllSounds:function(){var res,themeName,theme,resourceString;res=[];for(themeName in this.themes){if(this.themes.hasOwnProperty(themeName)){theme=this.themes[themeName];for(resourceString in theme.sfx){if(theme.sfx.hasOwnProperty(resourceString)){res.push(theme.sfx[resourceString]);}}}}
return res;},getAllMusic:function(){var res,themeName,theme,resourceString;res=[];for(themeName in this.themes){if(this.themes.hasOwnProperty(themeName)){theme=this.themes[themeName];for(resourceString in theme.music){if(theme.music.hasOwnProperty(resourceString)){res.push(theme.music[resourceString]);}}}}
return res;},loadClasses:function(paths){var objectName,i;for(i in paths){if(paths.hasOwnProperty(i)){objectName=paths[i].match(/(\w*)\.\w+$/)[1];if(window[objectName]){continue;}
engine.loadFiles(paths[i]);this.loaded.classes[objectName]=paths[i];}}
return true;},reloadAllClasses:function(){var i;for(i in this.loaded.classes){if(this.loaded.classes.hasOwnProperty(i)){engine.loadFiles(this.loaded.classes[i]);}}},loadThemes:function(themeNames,callback){if(callback!==undefined){this.onthemesloaded=callback;}
var name,req,i,total,theme,codeString;for(i=0;i<themeNames.length;i++){name=themeNames[i];if(this.themes[name]){continue;}
req=new XMLHttpRequest();req.open('GET',engine.themesPath+'/'+name+'/theme.js',false);req.send();if(req.status===404){;continue;}
codeString=req.responseText+"\n//# sourceURL=/"+engine.themesPath+'/'+name+'/theme.js';eval('theme = '+codeString);if(theme.inherit.length){this.loadThemes(theme.inherit);}
theme.inherit.push('External');this.themes[name]=theme;theme.resourcesCount=0;theme.resourcesLoaded=0;theme.masks={};theme.textures={};this.loadResources(theme,theme.images,'images');this.loadResources(theme,theme.sfx,'sfx');this.loadResources(theme,theme.music,'music');}
total=0;for(i in this.themes){if(this.themes.hasOwnProperty(i)){total+=this.themes[i].resourcesCount;}}
if(total===0){if(this.onthemesloaded){this.onthemesloaded();}}},loadResources:function(theme,object,typeString){var onload,res,path,i,format,images;onload=function(){var theme;if(this.hasAttribute('data-loaded')){return;}
this.setAttribute('data-loaded','true');theme=loader.themes[this.getAttribute('data-theme')];theme.resourcesLoaded++;loader.checkAllLoaded();};for(path in object){if(object.hasOwnProperty(path)){switch(typeString){case'images':res=new Image();format=object[path].match(/(png|jpg|jpeg|svg)/);if(format){format=format[0];}
res.src=engine.themesPath+"/"+theme.name+"/images/"+path.replace(/\./g,'/')+'.'+format;images=object[path].match(/; *(\d+) *images?/);if(images){res.imageLength=parseInt(images[1],10);}
else{res.imageLength=1;}
if(object[path].match(/; *bordered/)){res.spacing=1;}
else{res.spacing=0;}
theme.images[path]=res;res.onload=onload;theme.resourcesCount++;break;case'sfx':format=false;for(i=0;i<engine.host.supportedAudio.length;i++){if(object[path].search(engine.host.supportedAudio[i])!==-1){format=engine.host.supportedAudio[i];}}
if(!format){;continue;}
res=new Audio(engine.themesPath+"/"+theme.name+"/sfx/"+path.replace(/\./g,'/')+'.'+format);theme.sfx[path]=new Sound.Effect(res);if(engine.preloadSounds){res.setAttribute('preload','auto');res.addEventListener("canplaythrough",onload,false);theme.resourcesCount++;}
break;case'music':format=false;for(i=0;i<engine.host.supportedAudio.length;i++){if(object[path].search(engine.host.supportedAudio[i])!==-1){format=engine.host.supportedAudio[i];}}
if(!format){continue;}
res=new Audio(engine.themesPath+"/"+theme.name+"/music/"+path.replace(/\./g,'/')+'.'+format);theme.music[path]=new Sound.Music(res);if(engine.preloadSounds){res.setAttribute('preload','auto');res.addEventListener("canplaythrough",onload,false);theme.resourcesCount++;}
break;}
res.setAttribute('data-theme',theme.name);res.setAttribute('data-resourceString',path.replace(/\./g,'/'));}}},loadExternalResource:function(resourceString,path,onLoaded,typeString,options){typeString=typeString||"images";onLoaded=onLoaded||function(){};options=options||"";theme=this.themes.External;switch(typeString){case'images':res=new Image();res.src=path;images=options.match(/ *(\d+) *images?/);if(images){res.imageLength=parseInt(images[1],10);}
else{res.imageLength=1;}
if(options.match(/; *bordered/)){res.spacing=1;}
else{res.spacing=0;}
theme.images[resourceString]=res;res.onload=onLoaded;theme.resourcesCount++;break;case'sfx':format=path.match(/[^\.]*$/)[0];if(engine.host.supportedAudio.indexOf(format)===-1){return;}
res=new Audio(path);theme.sfx[resourceString]=new Sound.Effect(res);if(engine.preloadSounds){res.setAttribute('preload','auto');res.addEventListener("canplaythrough",onLoaded,false);theme.resourcesCount++;}
break;case'music':format=path.match(/[^\.]*$/)[0];if(engine.host.supportedAudio.indexOf(format)===-1){return;}
res=new Audio(path);theme.music[resourceString]=new Music(res);if(engine.preloadSounds){res.setAttribute('preload','auto');res.addEventListener("canplaythrough",onLoaded,false);theme.resourcesCount++;}
break;}
res.setAttribute('data-theme',theme.name);res.setAttribute('data-resourceString',resourceString);},generateMask:function(resourceString,alphaLimit){alphaLimit=alphaLimit!==undefined?alphaLimit:255;var image,canvas,ctx,bitmap,data,length,pixel,top,bottom,left,right,x,y;image=loader.getImage(resourceString);canvas=document.createElement('canvas');canvas.width=image.width;canvas.height=image.height;canvas.imageLength=image.imageLength;ctx=canvas.getContext('2d');ctx.drawImage(image,0,0,image.width,image.height);bitmap=ctx.getImageData(0,0,canvas.width,canvas.height);data=bitmap.data;length=data.length/4;top=bitmap.height;bottom=0;left=bitmap.width;right=0;for(pixel=0;pixel<length;pixel++){if(data[pixel*4+3]<alphaLimit){data[pixel*4]=0;data[pixel*4+1]=0;data[pixel*4+2]=0;data[pixel*4+3]=0;}
else{data[pixel*4]=0;data[pixel*4+1]=0;data[pixel*4+2]=0;data[pixel*4+3]=255;y=Math.floor(pixel/bitmap.width);x=pixel-y*bitmap.width;while(x>=Math.floor(image.width/image.imageLength)){x-=Math.floor(image.width/image.imageLength)+image.spacing;}
if(x<0){continue;}
top=Math.min(y,top);bottom=Math.max(y+1,bottom);left=Math.min(x,left);right=Math.max(x+1,right);}}
ctx.putImageData(bitmap,0,0);canvas.bBox=new Math.Rectangle(left,top,right-left,bottom-top).getPolygon();return canvas;},checkAllLoaded:function(){var i,total,loaded,theme;total=0;loaded=0;for(i in this.themes){if(this.themes.hasOwnProperty(i)){theme=this.themes[i];total+=theme.resourcesCount;loaded+=theme.resourcesLoaded;}}
if(loaded===total){if(this.onthemesloaded){this.onthemesloaded();}
return true;}
return false;}});new Class('Lib.Animatable',{animate:function(properties,options){var anim,i,c,loop,map,opt;anim={};map=properties;opt=options?options:{};anim.obj=this;loop=options.loop!==undefined?options.loop:(this.loop!==undefined?this.loop:engine.defaultAnimationLoop);anim.callback=opt.callback!==undefined?opt.callback:function(){};anim.easing=opt.easing!==undefined?opt.easing:"quadInOut";anim.duration=opt.duration!==undefined?opt.duration:1000;anim.onStep=opt.onStep!==undefined?opt.onStep:function(){};anim.prop={};for(i in map){if(map.hasOwnProperty(i)){anim.prop[i]={begin:this[i],end:map[i]};}}
c=0;for(i in anim.prop){if(anim.prop.hasOwnProperty(i)){if(anim.prop[i].begin===anim.prop[i].end&&!this.propertyIsAnimated(i)){delete anim.prop[i];}else{c++;}}}
if(!c&&anim.callback===function(){}){return;}
loop.addAnimation(anim);},isAnimated:function(){var roomId,room,name,loop,animId,animation;for(roomId=0;roomId<engine.roomList.length;roomId++){room=engine.roomList[roomId];for(name in room.loops){if(room.loops.hasOwnProperty(name)){loop=room.loops[name];for(animId=loop.animations.length-1;animId>-1;animId--){animation=loop.animations[animId];if(animation.obj===this){return true;}}}}}
return false;},propertyIsAnimated:function(property){var roomId,room,name,loop,animId,animation;for(roomId=0;roomId<engine.roomList.length;roomId++){room=engine.roomList[roomId];for(name in room.loops){if(room.loops.hasOwnProperty(name)){loop=room.loops[name];for(animId=loop.animations.length-1;animId>-1;animId--){animation=loop.animations[animId];if(animation.obj===this&&animation.prop[property]!==undefined){return true;}}}}}
return false;},getAnimations:function(){var animations,roomId,room,name,loop,animId,animation;animations=[];for(roomId=0;roomId<engine.roomList.length;roomId++){room=engine.roomList[roomId];for(name in room.loops){if(room.loops.hasOwnProperty(name)){loop=room.loops[name];for(animId=loop.animations.length-1;animId>-1;animId--){animation=loop.animations[animId];if(animation.obj===this){animations.push(animation);}}}}}
return animations;},stopAnimations:function(){var roomId,room,name;for(roomId=0;roomId<engine.roomList.length;roomId++){room=engine.roomList[roomId];for(name in room.loops){if(room.loops.hasOwnProperty(name)){room.loops[name].removeAnimationsOfObject(this);}}}},schedule:function(func,delay,loopName){var room;loopName=loopName||'eachFrame';room=this.getRoom();room.loops[loopName].schedule(this,func,delay);},});new Class('Lib.MatrixCalculation',{calculateLocalMatrix:function(object){var origin,scale,rotation,position;scale=this.makeScale(object.widthScale*object.size,object.heightScale*object.size);rotation=this.makeRotation(-object.direction);position=this.makeTranslation(object.x,object.y);return this.matrixMultiplyArray([scale,rotation,position]);},makeIdentity:function(){return[1,0,0,0,1,0,0,0,1];},makeTranslation:function(tx,ty){return[1,0,0,0,1,0,tx,ty,1];},makeRotation:function(direction){var c=Math.cos(direction);var s=Math.sin(direction);return[c,-s,0,s,c,0,0,0,1];},makeScale:function(sx,sy){return[sx,0,0,0,sy,0,0,0,1];},matrixMultiply:function(a,b){var a00=a[0*3+0];var a01=a[0*3+1];var a02=a[0*3+2];var a10=a[1*3+0];var a11=a[1*3+1];var a12=a[1*3+2];var a20=a[2*3+0];var a21=a[2*3+1];var a22=a[2*3+2];var b00=b[0*3+0];var b01=b[0*3+1];var b02=b[0*3+2];var b10=b[1*3+0];var b11=b[1*3+1];var b12=b[1*3+2];var b20=b[2*3+0];var b21=b[2*3+1];var b22=b[2*3+2];return[a00*b00+a01*b10+a02*b20,a00*b01+a01*b11+a02*b21,a00*b02+a01*b12+a02*b22,a10*b00+a11*b10+a12*b20,a10*b01+a11*b11+a12*b21,a10*b02+a11*b12+a12*b22,a20*b00+a21*b10+a22*b20,a20*b01+a21*b11+a22*b21,a20*b02+a21*b12+a22*b22];},matrixMultiplyArray:function(matrices){var r,i,len;r=matrices[0]
len=matrices.length
for(i=1;i<len;i++){r=this.matrixMultiply(r,matrices[i]);}
return r;},});new Class('Renderer.WebGL',[Lib.MatrixCalculation],{WebGL:function(canvas){var gl,options;this.canvas=canvas;this.cache={currentTexture:undefined,currentAlpha:undefined,textures:{},currentResolution:{width:0,height:0,}}
this.programs={};this.currentProgram=false;options={premultipliedAlpha:false,alpha:false,};this.gl=canvas.getContext('webgl',options)||canvas.getContext('experimental-webgl',options);gl=this.gl;gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.enable(gl.BLEND);this.initTextureShaderProgram();this.setProgram(this.programs.texture);},initTextureShaderProgram:function(){var gl,initShaders,initBuffers,program,locations;gl=this.gl;program=gl.createProgram();initShaders=function(){var vertexCode,fragmentCode,vertexShader,fragmentShader,textCoordBuffer,rectangleCornerBuffer;vertexCode='\
    attribute vec2 a_position;\
    attribute vec2 a_texCoord;\
    \
    uniform vec2 u_resolution;\
    uniform mat3 u_matrix;\
    \
    varying vec2 v_texCoord;\
    \
    void main() {\
     vec2 position = (u_matrix * vec3(a_position, 1)).xy;\
     vec2 zeroToOne = position / u_resolution;\
     vec2 zeroToTwo = zeroToOne * 2.0;\
     vec2 clipSpace = zeroToTwo - 1.0;\
     \
     gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\
     \
     v_texCoord = a_texCoord;\
    }';vertexShader=gl.createShader(gl.VERTEX_SHADER);gl.shaderSource(vertexShader,vertexCode);gl.compileShader(vertexShader);gl.attachShader(program,vertexShader);fragmentCode='\
    precision mediump float;\
    \
    uniform sampler2D u_image;\
    varying vec2 v_texCoord;\
    uniform float u_alpha;\
    \
    void main() {\
       vec4 textureColor = texture2D(u_image, v_texCoord);\
       gl_FragColor = vec4(textureColor.rgb, textureColor.a * u_alpha);\
    }';fragmentShader=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(fragmentShader,fragmentCode);gl.compileShader(fragmentShader);gl.attachShader(program,fragmentShader);gl.linkProgram(program);locations={a_texCoord:gl.getAttribLocation(program,"a_texCoord"),a_position:gl.getAttribLocation(program,"a_position"),u_resolution:gl.getUniformLocation(program,"u_resolution"),u_matrix:gl.getUniformLocation(program,"u_matrix"),u_alpha:gl.getUniformLocation(program,"u_alpha")}}
initBuffers=function(){textCoordBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,textCoordBuffer);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([0.0,0.0,1.0,0.0,0.0,1.0,0.0,1.0,1.0,0.0,1.0,1.0]),gl.STATIC_DRAW);gl.enableVertexAttribArray(locations.a_texCoord);gl.vertexAttribPointer(locations.a_texCoord,2,gl.FLOAT,false,0,0);rectangleCornerBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,rectangleCornerBuffer);gl.enableVertexAttribArray(locations.a_position);gl.vertexAttribPointer(locations.a_position,2,gl.FLOAT,false,0,0);}
initShaders();initBuffers();this.programs.texture={pointer:program,locations:locations,}},setProgram:function(program){this.currentProgram=program;this.gl.useProgram(program.pointer);},render:function(cameras){var camerasLength,roomsLength,i,ii,wm,gl,w,h;gl=this.gl
camerasLength=cameras.length;for(i=0;i<camerasLength;i++){camera=cameras[i];w=camera.captureRegion.width;h=camera.captureRegion.height;if(this.cache.currentResolution.width!==w||this.cache.currentResolution.height!==h){this.cache.currentResolution.width=w;this.cache.currentResolution.height=w;gl.uniform2f(this.currentProgram.locations.u_resolution,w,h);}
wm=this.makeTranslation(-camera.captureRegion.x,-camera.captureRegion.y);gl.viewport(camera.projectionRegion.x,camera.projectionRegion.y,camera.projectionRegion.width,camera.projectionRegion.height);rooms=[engine.masterRoom,camera.room];roomsLength=rooms.length;for(ii=0;ii<roomsLength;ii++){this.renderTree(rooms[ii],wm);}}},renderTree:function(object,wm){var i,len,child,localWm,offset,gl;gl=this.gl;localWm=this.matrixMultiplyArray([this.calculateLocalMatrix(object),wm]);offset=this.makeTranslation(-object.offset.x,-object.offset.y);if(!object.isVisible()){return;}
if(this.cache.currentAlpha!==object.opacity){this.cache.currentAlpha=object.opacity;gl.uniform1f(this.currentProgram.locations.u_alpha,object.opacity);}
switch(object.renderType){case'textblock':if(this.cache.textures[object.bm.oldSrc]){delete this.cache.textures[object.bm.oldSrc];}
case'sprite':this.renderSprite(object,this.matrixMultiply(offset,localWm));break;}
if(object.children){len=object.children.length;for(i=0;i<len;i++){this.renderTree(object.children[i],localWm);}}},renderSprite:function(object,wm){var gl,t,l;gl=this.gl;l=this.currentProgram.locations;t=this.getSpriteTexture(object);if(this.cache.currentTexture!==t){this.cache.currentTexture=t;gl.bindTexture(gl.TEXTURE_2D,t);this.setPlane(gl,0,0,object.bm.width,object.bm.height);}
gl.uniformMatrix3fv(this.locations.u_matrix,false,wm);gl.drawArrays(gl.TRIANGLES,0,6);},getSpriteTexture:function(object){return this.cache.textures[object.bm.src]||this.createSpriteTexture(object.bm);},createSpriteTexture:function(image){var gl,texture;gl=this.gl;texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,image);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.bindTexture(gl.TEXTURE_2D,null);this.cache.textures[image.src]=texture;return texture;},setPlane:function(gl,x,y,width,height){var x1=x;var x2=x+width;var y1=y;var y2=y+height;gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([x1,y1,x2,y1,x1,y2,x1,y2,x2,y1,x2,y2]),gl.STATIC_DRAW);},})
new Class('Renderer.Canvas',[Lib.MatrixCalculation],{Canvas:function(canvas){var gl,options;this.canvas=canvas;this.context=canvas.getContext('2d');},render:function(cameras){var camerasLength,roomsLength,i,ii,wm,wmT,wmS,c,w,h;camerasLength=cameras.length;c=this.context;c.clearRect(0,0,this.canvas.width,this.canvas.height);for(i=0;i<camerasLength;i++){camera=cameras[i];c.save();w=camera.captureRegion.width;h=camera.captureRegion.height;wmT=this.makeTranslation(-camera.captureRegion.x,-camera.captureRegion.y);if(camera.captureRegion.width!==0&&camera.captureRegion.height!==0){wmS=this.makeScale(camera.projectionRegion.width/camera.captureRegion.width,camera.projectionRegion.height/camera.captureRegion.height);}
else{wmS=this.makeIdentity();}
wm=this.matrixMultiply(wmT,wmS);wm=this.matrixMultiply(wm,this.makeTranslation(camera.projectionRegion.x,camera.projectionRegion.y));c.beginPath();c.moveTo(camera.projectionRegion.x,camera.projectionRegion.y);c.lineTo(camera.projectionRegion.x+camera.projectionRegion.width,camera.projectionRegion.y);c.lineTo(camera.projectionRegion.x+camera.projectionRegion.width,camera.projectionRegion.y+camera.projectionRegion.height);c.lineTo(camera.projectionRegion.x,camera.projectionRegion.y+camera.projectionRegion.height);c.closePath();c.clip();rooms=[engine.masterRoom,camera.room];roomsLength=rooms.length;for(ii=0;ii<roomsLength;ii++){this.renderTree(rooms[ii],wm);}
c.restore();}},renderTree:function(object,wm){var i,len,child,localWm,offset;localWm=this.matrixMultiplyArray([this.calculateLocalMatrix(object),wm]);if(!object.isVisible()){return;}
if(object.renderType!==''){offset=this.matrixMultiply(this.makeTranslation(-object.offset.x,-object.offset.y),localWm);this.context.setTransform(offset[0],offset[1],offset[3],offset[4],offset[6],offset[7]);this.context.globalAlpha=object.opacity;}
switch(object.renderType){case'textblock':case'sprite':this.renderSprite(object);break;case'circle':this.renderCircle(object);break;case'line':this.renderLine(object);break;case'rectangle':this.renderRectangle(object);break;case'polygon':this.renderPolygon(object);break;}
if(object.children){len=object.children.length;for(i=0;i<len;i++){this.renderTree(object.children[i],localWm);}}},renderSprite:function(object){if(object.imageLength!==1&&object.animationSpeed!==0){if(engine.gameTime-object.animationLastSwitch>1000/object.animationSpeed){object.imageNumber=object.imageNumber+(object.animationSpeed>0?1:-1);object.animationLastSwitch=engine.gameTime;if(object.imageNumber===object.imageLength){object.imageNumber=object.animationLoops?0:object.imageLength-1;}
else if(object.imageNumber===-1){object.imageNumber=object.animationLoops?object.imageLength-1:0;}}}
this.context.drawImage(object.bm,(object.clipWidth+object.bm.spacing)*object.imageNumber,0,object.clipWidth,object.clipHeight,0,0,object.clipWidth,object.clipHeight);},renderCircle:function(object){var c;c=this.context;c.strokeStyle=object.strokeStyle;c.fillStyle=object.fillStyle;c.beginPath();c.arc(0,0,object.radius,0,Math.PI*2,true);c.lineWidth=object.lineWidth;c.globalAlpha=object.opacity;c.stroke();c.fill();},renderPolygon:function(object){var c,i,len;c=this.context;c.strokeStyle=object.strokeStyle;c.fillStyle=object.fillStyle;if(object.lineDash!==[]&&c.setLineDash){c.setLineDash(object.lineDash);}
c.beginPath();len=object.points.length;for(i=0;i<len;i++){c.lineTo(object.points[i].x,object.points[i].y);}
c.lineWidth=object.lineWidth;c.globalAlpha=object.opacity;if(object.closed){c.closePath();c.fill();c.stroke();}
else{c.fill();c.stroke();c.closePath();}},renderLine:function(object){var c;c=this.context;c.strokeStyle=object.strokeStyle;c.globalAlpha=object.opacity;c.beginPath();c.moveTo(object.a.x,object.a.y);c.lineTo(object.b.x,object.b.y);c.lineWidth=object.lineWidth;c.lineCap=object.lineCap;c.stroke();},renderRectangle:function(object){var c;c=this.context;c.strokeStyle=object.strokeStyle;c.fillStyle=object.fillStyle;c.beginPath();c.moveTo(0,0);c.lineTo(object.width,0);c.lineTo(object.width,object.height);c.lineTo(0,object.height);c.closePath();c.lineWidth=object.lineWidth;c.fill();c.stroke();},transformCanvasContext:function(object,context){var c,x,y;c=context;if(engine.avoidSubPixelRendering){x=Math.round(object.x);y=Math.round(object.y);}
else{x=object.x;y=object.y;}
c.globalAlpha=object.opacity;if(object.composite!=='source-over'){c.globalCompositeOperation=object.composite;}
if(x!==0||y!==0){c.translate(x,y);}
if(object.direction!==0){c.rotate(object.direction);}
if(object.size!==1||object.widthScale!==1||object.heightScale!==1){c.scale(object.widthScale*object.size,object.heightScale*object.size);}},restoreCanvasContext:function(object,context){var c,x,y;c=context;if(engine.avoidSubPixelRendering){x=Math.round(object.x);y=Math.round(object.y);}
else{x=object.x;y=object.y;}
if(object.size!==1||object.widthScale!==1||object.heightScale!==1){c.scale(1/(object.widthScale*object.size),1/(object.heightScale*object.size));}
if(object.direction!==0){c.rotate(-object.direction);}
if(x!==0||y!==0){c.translate(-x,-y);}
if(object.composite!=='source-over'){c.globalCompositeOperation='source-over';}
c.globalAlpha=object.opacity;},})
new Class('Math.Vector',[Lib.Animatable],{Vector:function(x,y){this.set(x,y);this.opacity=1;},set:function(x,y){this.x=x!==undefined?x:0;this.y=y!==undefined?y:0;return this;},setFromDirection:function(direction,length){this.x=Math.cos(direction)*length;this.y=Math.sin(direction)*length;return this;},copy:function(){return new Math.Vector(this.x,this.y);},move:function(x,y){this.x+=x;this.y+=y;return this;},rotate:function(direction){this.setFromDirection(this.getDirection()+direction,this.getLength());return this;},scale:function(scaleH,scaleV){scaleV=scaleV!==undefined?scaleV:scaleH;this.x*=scaleH;this.y*=scaleV;return this;},add:function(vector){if(vector.implements(Math.Vector)){this.x+=vector.x;this.y+=vector.y;}
else if(typeof vector==='number'){this.x+=vector;this.y+=vector;}
return this;},subtract:function(vector){if(vector.implements(Math.Vector)){this.x-=vector.x;this.y-=vector.y;}
else if(typeof vector==='number'){this.x-=vector;this.y-=vector;}
return this;},divide:function(vector){if(vector.implements(Math.Vector)){this.x/=vector;this.y/=vector;}
else if(typeof vector==='number'){this.x/=vector;this.y/=vector;}
return this;},multiply:function(vector){this.x*=vector.x;this.y*=vector.y;return this;},getDot:function(vector){return this.x*vector.x+this.y*vector.y;},getCross:function(vector){return this.x*vector.y-this.y*vector.x;},getLength:function(){return Math.sqrt(this.getDot(this));},getDirection:function(){return Math.atan2(this.y,this.x);},getDirectionTo:function(point){return point.copy().subtract(this).getDirection();},getDistance:function(object){if(object.implements(Math.Vector)){return object.copy().subtract(this).getLength();}
if(object.implements(Math.Line)){return object.getDistance(this);}
if(object.implements(Math.Circle)){return object.getDistance(this);}
if(object.implements(Math.Rectangle)){return object.getDistance(this);}
if(object.implements(Math.Polygon)){return object.getDistance(this);}}});new Class('Math.Line',[Lib.Animatable],{Line:function(startVector,endVector){startVector=startVector!==undefined?startVector:new Math.Vector();endVector=endVector!==undefined?endVector:new Math.Vector();this.setFromVectors(startVector,endVector);},setFromVectors:function(startVector,endVector){this.a=startVector;this.b=endVector;return this;},setFromCoordinates:function(x1,y1,x2,y2){x1=x1!==undefined?x1:0;y1=y1!==undefined?y1:0;x2=x2!==undefined?x2:0;y2=y2!==undefined?y2:0;this.a=new Math.Vector(x1,y1);this.b=new Math.Vector(x2,y2);return this;},copy:function(){return new Math.Line(this.a,this.b);},move:function(x,y){this.a.move(x,y);this.b.move(x,y);return this;},rotate:function(direction){this.a.rotate(direction);this.b.rotate(direction);return this;},scale:function(scaleH,scaleV){this.a.scale(scaleH,scaleV);this.b.scale(scaleH,scaleV);return this;},add:function(vector){this.a.add(vector);this.b.add(vector);return this;},subtract:function(vector){this.a.substract(vector);this.b.substract(vector);return this;},divide:function(vector){this.a.divide(vector);this.b.divide(vector);return this;},multiply:function(vector){this.a.multiply(vector);this.b.multiply(vector);return this;},intersects:function(object){if(object.implements(Math.Line)){var c1,c2;c1=(this.b.x-this.a.x)*(object.a.y-this.b.y)-(object.a.x-this.b.x)*(this.b.y-this.a.y);c2=(this.b.x-this.a.x)*(object.b.y-this.b.y)-(object.b.x-this.b.x)*(this.b.y-this.a.y);if(c1*c2>0){return false;}
c1=(object.b.x-object.a.x)*(this.a.y-object.b.y)-(this.a.x-object.b.x)*(object.b.y-object.a.y);c2=(object.b.x-object.a.x)*(this.b.y-object.b.y)-(this.b.x-object.b.x)*(object.b.y-object.a.y);return c1*c2<0;}
else if(object.implements(Math.Circle)){return object.intersects(this);}
else if(object.implements(Math.Rectangle)){return object.getPolygon().intersects(this);}
else if(object.implements(Math.Polygon)){return object.intersects(this);}},getLength:function(){return this.b.copy().subtract(this.a).getLength();},getDistance:function(object){var ba,ab,bc,ac;if(object.implements(Math.Vector)){ba=this.a.copy().subtract(this.b);ab=this.b.copy().subtract(this.a);bc=object.copy().subtract(this.b);ac=object.copy().subtract(this.a);if(ab.getDot(bc)>0){return bc.getLength();}
else if(ba.getDot(ac)>0){return ac.getLength();}
else{return Math.abs(ab.getCross(ac)/ab.getLength());}}
else if(object.implements(Math.Line)){if(this.intersects(object)){return 0;}
else{return Math.min(this.getDistance(object.a),this.getDistance(object.b),object.getDistance(this.a),object.getDistance(this.b));}}
else if(object.implements(Math.Rectangle)){return object.getDistance(this);}
else if(object.implements(Math.Circle)){return object.getDistance(this);}},getPolygon:function(){return new Math.Polygon([this.a.copy(),this.b.copy()]);},});new Class('Math.Circle',[Lib.Animatable],{Circle:function(x,y,radius){this.set(x,y,radius);},set:function(x,y,radius){x=x!==undefined?x:0;y=y!==undefined?y:0;radius=radius!==undefined?radius:0;this.x=x;this.y=y;this.radius=radius;return this;},copy:function(){return new Math.Circle(this.x,this.y,this.radius);},move:function(x,y){this.x+=x;this.y+=y;return this;},moveTo:function(x,y){this.x=x;this.y=y;return this;},scale:function(factor){this.radius*=factor;return this;},getArea:function(){return Math.pow(this.radius)*Math.PI;},getDistance:function(object){if(object.implements(Math.Vector)){return Math.max(0,object.getDistance(new Math.Vector(this.x,this.y))-this.radius);}
else if(object.implements(Math.Line)){return Math.max(0,object.getDistance(new Math.Vector(this.x,this.y))-this.radius);}
else if(object.implements(Math.Circle)){return Math.max(0,new Math.Vector(this.x,this.y).getDistance(new Math.Vector(object.x,object.y))-(this.radius+object.radius));}
else if(object.implements(Math.Rectangle)){return object.getDistance(this);}
else if(object.implements(Math.Polygon)){return object.getDistance(this);}},contains:function(object){var i,cDist;if(object.implements(Math.Vector)){return object.copy().move(-this.x,-this.y).getLength()<this.radius;}
else if(object.implements(Math.Line)){return this.contains(object.a)&&this.contains(object.b);}
else if(object.implements(Math.Circle)){cDist=new Math.Vector(object.x,object.y).move(-this.x,-this.y).getLength();return cDist+object.radius<this.radius;}
else if(object.implements(Math.Rectangle)){return this.contains(object.getPolygon());}
else if(object.implements(Math.Polygon)){for(i=0;i<object.points.length;i++){if(!this.contains(object.points[i])){return false;}}
return true;}},intersects:function(object){if(object.implements(Math.Line)){return this.contains(object)===false&&object.getDistance(this)<=0;}
else if(object.implements(Math.Circle)){return!this.contains(object)&&!object.contains(this)&&new Math.Vector(this.x,this.y).getDistance(new Math.Vector(object.x,object.y))<=this.radius+object.radius;}
else if(object.implements(Math.Rectangle)){return object.getPolygon().intersects(this);}
else if(object.implements(Math.Polygon)){return object.intersects(this);}}});new Class('Math.Rectangle',[Math.Vector],{Rectangle:function(x,y,width,height,fillStyle,strokeStyle,lineWidth){this.set(x,y,width,height);},set:function(x,y,width,height){this.x=x!==undefined?x:0;this.y=y!==undefined?y:0;this.width=width!==undefined?width:0;this.height=height!==undefined?height:0;return this;},setFromVectors:function(position,size){position=position!==undefined?position:new Math.Vector();size=size!==undefined?size:new Math.Vector();this.x=position.x;this.y=position.y;this.width=size.x;this.height=size.y;return this;},copy:function(){return new Math.Rectangle(this.x,this.y,this.width,this.height);},move:function(x,y){this.x+=x;this.y+=y;return this;},moveTo:function(x,y){this.x=x;this.y=y;return this;},getOverlap:function(rectangle){var x2,y2,rx2,ry2,crop;x2=this.x+this.width;y2=this.y+this.height;rx2=rectangle.x+rectangle.width;ry2=rectangle.y+rectangle.height;crop=new Math.Rectangle();crop.x=rectangle.x>this.x?rectangle.x:this.x;crop.y=rectangle.y>this.y?rectangle.y:this.y;x2=rx2>x2?x2:rx2;y2=ry2>y2?y2:ry2;crop.width=x2-crop.x;crop.height=y2-crop.y;return crop.width<=0||crop.height<=0?false:crop;},scale:function(scaleH,scaleV){scaleV=scaleV!==undefined?scaleV:scaleH;this.width*=scaleH;this.height*=scaleV;return this;},getBoundingRectangle:function(rectangle){var x2,y2,rx2,ry2,crop;x2=this.x+this.width;y2=this.y+this.height;rx2=rectangle.x+rectangle.width;ry2=rectangle.y+rectangle.height;crop=new Math.Rectangle();crop.x=rectangle.x<this.x?rectangle.x:this.x;crop.y=rectangle.y<this.y?rectangle.y:this.y;x2=rx2<x2?x2:rx2;y2=ry2<y2?y2:ry2;crop.width=x2-crop.x;crop.height=y2-crop.y;return crop;},getPolygon:function(){return new Math.Polygon(this.getPoints());},getPoints:function(){return[new Math.Vector(this.x,this.y),new Math.Vector(this.x+this.width,this.y),new Math.Vector(this.x+this.width,this.y+this.height),new Math.Vector(this.x,this.y+this.height)];},getArea:function(){return this.width*this.height;},getDiagonal:function(){return Math.sqrt(Math.pow(this.width,2)+Math.pow(this.height,2));},getDistance:function(object){return this.getPolygon().getDistance(object);},contains:function(object){if(object.implements(Math.Rectangle)){return this.contains(new Math.Vector(object.x,object.y))&&this.contains(new Math.Vector(object.x+object.width,object.y+object.height));}
if(object.implements(Math.Line)){return this.contains(object.a)&&this.contains(object.b);}
if(object.implements(Math.Vector)){return(object.x>this.x&&object.x<this.x+this.width&&object.y>this.y&&object.y<this.y+this.height)}
return this.getPolygon().contains(object);},intersects:function(object){return this.getPolygon().intersects(object);}});new Class('Math.Polygon',{Polygon:function(points){this.setFromPoints(points);},setFromPoints:function(points){this.points=points;return this;},setFromCoordinates:function(x1,y1,x2,y2,x3,y3){var numPoints,i,x,y;numPoints=Math.floor(arguments.length/2);this.points=[];for(i=0;i<numPoints;i++){x=arguments[i*2];y=arguments[i*2+1];this.points.push(new Math.Vector(x,y));}
return this;},move:function(x,y){return this.add(new Math.Vector(x,y));},add:function(vector){var i;for(i=0;i<this.points.length;i++){this.points[i].add(vector);}
return this;},rotate:function(direction){var i;for(i=0;i<this.points.length;i++){this.points[i].rotate(direction);}
return this;},scale:function(scaleH,scaleV){var i;for(i=0;i<this.points.length;i++){this.points[i].scale(scaleH,scaleV);}
return this;},copy:function(){return new Math.Polygon(this.getPoints());},getPoints:function(){var points,i;points=[];for(i=0;i<this.points.length;i++){points.push(this.points[i].copy());}
return points;},getLines:function(){var lines,points,i,to;lines=[];points=this.points;for(i=0;i<points.length;i++){to=i===points.length-1?0:i+1;lines.push(new Math.Line(points[i],points[to]));}
return lines;},getBoundingRectangle:function(){var startVector,endVector,i;startVector=new Math.Vector(this.points[0].x,this.points[0].y);endVector=startVector.copy();for(i=0;i<this.points.length;i++){startVector.x=Math.min(this.points[i].x,startVector.x);startVector.y=Math.min(this.points[i].y,startVector.y);endVector.x=Math.max(this.points[i].x,endVector.x);endVector.y=Math.max(this.points[i].y,endVector.y);}
return new Math.Rectangle().setFromVectors(startVector,endVector.subtract(startVector));},getDistance:function(object){var dist,lines,objLines,i,ii,pVector;dist=2E+10308;lines=this.getLines();if(object.implements(Math.Vector)){for(i=0;i<lines.length;i++){dist=Math.min(dist,lines[i].getDistance(object));if(dist<0){break;}}
return dist;}
else if(object.implements(Math.Line)){for(i=0;i<lines.length;i++){dist=Math.min(dist,lines[i].getDistance(object));if(dist<0){break;}}
return dist;}
else if(object.implements(Math.Circle)){pVector=new Math.Vector(object.x,object.y);for(i=0;i<lines.length;i++){dist=Math.min(dist,lines[i].getDistance(pVector));if(dist<0){break;}}
return Math.max(0,dist-object.radius);}
else if(object.implements(Math.Rectangle)){return object.getDistance(this);}
else if(object.implements(Math.Polygon)){objLines=object.getLines();for(i=0;i<lines.length;i++){for(ii=0;ii<objLines.length;ii++){dist=Math.min(dist,lines[i].getDistance(objLines[ii]));if(dist<0){break;}}
if(dist<0){break;}}
return dist;}},contains:function(object){if(object.implements(Math.Vector)){return this.intersects(new Math.Line().setFromCoordinates(-123456,-98765,object.x,object.y),true)%2;}
else if(object.implements(Math.Line)){return!this.intersects(object)&&this.contains(object.a);}
else if(object.implements(Math.Circle)){if(this.contains(new Math.Vector(object.x,object.y))){return!this.intersects(object);}
else{return false;}}
else if(object.implements(Math.Rectangle)){return this.contains(object.getPolygon());}
else if(object.implements(Math.Polygon)){return object.points.length>0&&!this.intersects(object)&&this.contains(object.points[0]);}},intersects:function(object,countIntersections){var intersectionCount,lines,line,oLines,oLine,i,ii;countIntersections=countIntersections!==undefined?countIntersections:false;if(countIntersections){intersectionCount=0;}
if(object.implements(Math.Line)){lines=this.getLines();for(i=0;i<lines.length;i++){line=lines[i];if(line.intersects(object)){if(countIntersections){intersectionCount++;}
else{return true;}}}}
else if(object.implements(Math.Circle)){lines=this.getLines();for(i=0;i<lines.length;i++){if(object.intersects(lines[i])){if(countIntersections){intersectionCount++;}
else{return true;}}}}
else if(object.implements(Math.Rectangle)){return this.intersects(object.getPolygon());}
else if(object.implements(Math.Polygon)){lines=this.getLines();oLines=object.getLines();for(i=0;i<lines.length;i++){line=lines[i];for(ii=0;ii<oLines.length;ii++){oLine=oLines[ii];if(line.intersects(oLine)){if(countIntersections){intersectionCount++;}
else{return true;}}}}}
if(countIntersections){return intersectionCount;}
else{return false;}},});new Class('View.Child',[Lib.Animatable],{Child:function(){this.renderType='';if(engine.enableRedrawRegions){this.ChildInitWithRedrawRegions();}
else{this.ChildInitWithoutRedrawRegions();}
engine.registerObject(this);},ChildInitWithoutRedrawRegions:function(){this.x=0;this.y=0;this.opacity=1;this.direction=0;this.size=1;this.widthScale=1;this.heightScale=1;var hidden={offset:new Math.Vector(),}
Object.defineProperty(this,'offset',{get:function(){return hidden.offset;},set:function(value){if(typeof value==='string'){this.offsetGlobal=value;hidden.offset=this.parseOffsetGlobal(value);}
else{this.offsetGlobal=false;hidden.offset=value;}
return value;}});},ChildInitWithRedrawRegions:function(){this.hasChanged=false;var hidden;hidden={x:0,y:0,opacity:1,direction:0,size:1,widthScale:1,heightScale:1,offset:undefined,parentObject:this};Object.defineProperty(this,'x',{get:function(){return hidden.x;},set:function(value){if(hidden.x!==value){hidden.x=value;this.onAfterChange();}}});Object.defineProperty(this,'y',{get:function(){return hidden.y;},set:function(value){if(hidden.y!==value){hidden.y=value;this.onAfterChange();}}});Object.defineProperty(this,'opacity',{get:function(){return hidden.opacity;},set:function(value){if(hidden.opacity!==value){hidden.opacity=value;this.onAfterChange();}}});Object.defineProperty(this,'direction',{get:function(){return hidden.direction;},set:function(value){if(hidden.direction!==value){hidden.direction=value;this.onAfterChange();}}});Object.defineProperty(this,'size',{get:function(){return hidden.size;},set:function(value){if(hidden.size!==value){hidden.size=value;this.onAfterChange();}}});Object.defineProperty(this,'widthScale',{get:function(){return hidden.widthScale;},set:function(value){if(hidden.widthScale!==value){hidden.widthScale=value;this.onAfterChange();}}});Object.defineProperty(this,'heightScale',{get:function(){return hidden.heightScale;},set:function(value){if(hidden.heightScale!==value){hidden.heightScale=value;this.onAfterChange();}}});Object.defineProperty(this,'offset',{get:function(){return hidden.offset;},set:function(value){if(hidden.offset!==value){hidden.offset=value;var off={x:value.x,y:value.y,};Object.defineProperty(hidden.offset,'x',{get:function(){return off.x;},set:function(value){if(off.x!==value){off.x=value;hidden.parentObject.onAfterChange();}}});Object.defineProperty(hidden.offset,'y',{get:function(){return off.y;},set:function(value){if(off.y!==value){off.y=value;hidden.parentObject.onAfterChange();}}});this.onAfterChange();}}});this.offset=new Math.Vector();},onAfterChange:function(){if(!this.hasChanged&&this.isDrawn()){this.lastRedrawRegion=this.currentRedrawRegion;this.currentRedrawRegion=this.getCombinedRedrawRegion?this.getCombinedRedrawRegion():this.getRedrawRegion();if(this.currentRedrawRegion){engine.redrawObjects.push(this);this.hasChanged=true;}}},parseOffsetGlobal:function(offset){return new Math.Vector();},isInVisibleRoom:function(){var p;p=this.getParents().pop();return(p===engine.currentRoom||p===engine.masterRoom);},isDrawn:function(){return this.isVisible()&&this.isInVisibleRoom();},getRoomPosition:function(){var pos,parents,parent,i;parents=this.getParents();if(parents.length&&parents[parents.length-1].implements(Engine.Room)){pos=new Math.Vector(this.x,this.y);for(i=0;i<parents.length;i++){parent=parents[i];pos.scale(parent.widthScale*parent.size,parent.heightScale*parent.size);pos.rotate(parent.direction);pos.move(parent.x,parent.y);}
return pos;}
else{return false;}},getParents:function(){var parent,parents;parents=[];parent=this;while((parent=parent.parent)!==undefined){parents.push(parent);}
return parents;},getRoom:function(){var parents,ancestor;parents=this.getParents();if(parents.length===0){return false;}
ancestor=parents[parents.length-1];return ancestor.implements(Engine.Room)?ancestor:false;},moveTo:function(x,y){this.x=x||0;this.y=y||0;},getDistanceTo:function(child){return this.getRoomPosition().subtract(child.getRoomPosition()).getLength();},getDirectionTo:function(child){return child.getRoomPosition().subtract(this.getRoomPosition()).getDirection();},isVisible:function(){return!(this.size===0||this.widthScale===0||this.heightScale===0);}});new Class('View.Line',[Math.Line,View.Child],{Line:function(startVector,endVector,strokeStyle,lineWidth,lineCap){this.Child();this.renderType='line';if(engine.enableRedrawRegions){this.LineInitWithRedrawRegions(startVector,endVector,strokeStyle,lineWidth,lineCap);}
else{this.LineInitWithoutRedrawRegions(startVector,endVector,strokeStyle,lineWidth,lineCap);}},LineInitWithoutRedrawRegions:function(startVector,endVector,strokeStyle,lineWidth,lineCap){this.strokeStyle=strokeStyle||"#000";this.lineWidth=lineWidth||1;this.lineCap=lineCap||'butt';this.setFromVectors(startVector||new Math.Vector(),endVector||new Math.Vector());},LineInitWithRedrawRegions:function(startVector,endVector,strokeStyle,lineWidth,lineCap){var hidden;hidden={strokeStyle:strokeStyle||"#000",lineWidth:lineWidth||1,lineCap:lineCap||'butt',a:undefined,b:undefined,parentObject:this};Object.defineProperty(this,'strokeStyle',{get:function(){return hidden.strokeStyle;},set:function(value){if(hidden.strokeStyle!==value){hidden.strokeStyle=value;this.onAfterChange();}}});Object.defineProperty(this,'lineCap',{get:function(){return hidden.lineCap;},set:function(value){if(hidden.lineCap!==value){hidden.lineCap=value;this.onAfterChange();}}});Object.defineProperty(this,'lineWidth',{get:function(){return hidden.lineWidth;},set:function(value){if(hidden.lineWidth!==value){hidden.lineWidth=value;this.onAfterChange();}}});Object.defineProperty(this,'a',{get:function(){return hidden.a;},set:function(value){if(hidden.a!==value){hidden.a=value;var xHidden,yHidden;xHidden=hidden.a.x;yHidden=hidden.a.y;Object.defineProperty(hidden.a,'x',{get:function(){return xHidden;},set:function(value){if(xHidden!==value){xHidden=value;hidden.parentObject.onAfterChange();}}});Object.defineProperty(hidden.a,'y',{get:function(){return yHidden;},set:function(value){if(yHidden!==value){yHidden=value;hidden.parentObject.onAfterChange();}}});this.onAfterChange();}}});Object.defineProperty(this,'b',{get:function(){return hidden.b;},set:function(value){if(hidden.b!==value){hidden.b=value;var xHidden,yHidden;xHidden=hidden.b.x;yHidden=hidden.b.y;Object.defineProperty(hidden.b,'x',{get:function(){return xHidden;},set:function(value){if(xHidden!==value){xHidden=value;hidden.parentObject.onAfterChange();}}});Object.defineProperty(hidden.b,'y',{get:function(){return yHidden;},set:function(value){if(yHidden!==value){yHidden=value;hidden.parentObject.onAfterChange();}}});this.onAfterChange();}}});this.setFromVectors(startVector||new Math.Vector(),endVector||new Math.Vector());},getRedrawRegion:function(){var box,parents,parent,i,ln;box=this.getPolygon();parents=this.getParents();parents.unshift(this);for(i=0;i<parents.length;i++){parent=parents[i];box.scale(parent.size*parent.widthScale,parent.size*parent.heightScale);box.rotate(parent.direction);box.move(parent.x,parent.y);}
box=box.getBoundingRectangle();ln=Math.ceil(this.lineWidth/2);box.x=Math.floor(box.x-ln);box.y=Math.floor(box.y-ln);box.width=Math.ceil(box.width+ln*2+1);box.height=Math.ceil(box.height+ln*2+1);return box;},});new Class('View.Circle',[Math.Circle,View.Child],{Circle:function(x,y,radius,fillStyle,strokeStyle,lineWidth){this.Child();this.renderType='circle';if(engine.enableRedrawRegions){this.CircleInitWithRedrawRegions(x,y,radius,fillStyle,strokeStyle,lineWidth);}
else{this.CircleInitWithoutRedrawRegions(x,y,radius,fillStyle,strokeStyle,lineWidth);}},CircleInitWithoutRedrawRegions:function(x,y,radius,fillStyle,strokeStyle,lineWidth){this.radius=radius;this.fillStyle=fillStyle||"#000";this.strokeStyle=strokeStyle||"#000";this.lineWidth=lineWidth||1;this.set(x,y,radius);},CircleInitWithRedrawRegions:function(x,y,radius,fillStyle,strokeStyle,lineWidth){var hidden;hidden={radius:radius,fillStyle:fillStyle||"#000",strokeStyle:strokeStyle||"#000",lineWidth:lineWidth||1};Object.defineProperty(this,'radius',{get:function(){return hidden.radius;},set:function(value){if(hidden.radius!==value){hidden.radius=value;this.onAfterChange();}}});Object.defineProperty(this,'fillStyle',{get:function(){return hidden.fillStyle;},set:function(value){if(hidden.fillStyle!==value){hidden.fillStyle=value;this.onAfterChange();}}});Object.defineProperty(this,'strokeStyle',{get:function(){return hidden.strokeStyle;},set:function(value){if(hidden.strokeStyle!==value){hidden.strokeStyle=value;this.onAfterChange();}}});Object.defineProperty(this,'lineWidth',{get:function(){return hidden.lineWidth;},set:function(value){if(hidden.lineWidth!==value){hidden.lineWidth=value;this.onAfterChange();}}});this.set(x,y,radius);},getRedrawRegion:function(){var rect,ln;ln=Math.ceil(this.lineWidth/2);rect=new Math.Rectangle(Math.floor(this.x-(this.radius+ln+5)),Math.floor(this.y-(this.radius+ln+5)),Math.ceil((this.radius+ln+5)*2),Math.ceil((this.radius+ln+5)*2));return rect.add(this.parent.getRoomPosition());},});new Class('View.Rectangle',[Math.Rectangle,View.Child],{Rectangle:function(x,y,width,height,fillStyle,strokeStyle,lineWidth){this.Child();this.renderType='rectangle';if(engine.enableRedrawRegions){this.RectangleInitWithRedrawRegions(x,y,width,height,fillStyle,strokeStyle,lineWidth);}
else{this.RectangleInitWithoutRedrawRegions(x,y,width,height,fillStyle,strokeStyle,lineWidth);}},RectangleInitWithoutRedrawRegions:function(x,y,width,height,fillStyle,strokeStyle,lineWidth){var hidden;this.width=width||0;this.height=height||0;this.fillStyle=fillStyle||"#000";this.strokeStyle=strokeStyle||"#000";hidden={lineWidth:lineWidth||0,};Object.defineProperty(this,'lineWidth',{get:function(){return hidden.lineWidth;},set:function(value){if(hidden.lineWidth!==value){hidden.lineWidth=value;if(this.offsetGlobal){this.offset=this.offsetGlobal;}}}});this.set(x,y,width,height);},RectangleInitWithRedrawRegions:function(x,y,width,height,fillStyle,strokeStyle,lineWidth){var hidden;hidden={width:width||0,height:height||0,fillStyle:fillStyle||"#000",strokeStyle:strokeStyle||"#000",lineWidth:lineWidth||0,};Object.defineProperty(this,'width',{get:function(){return hidden.width;},set:function(value){if(hidden.width!==value){hidden.width=value;this.onAfterChange();}}});Object.defineProperty(this,'height',{get:function(){return hidden.height;},set:function(value){if(hidden.height!==value){hidden.height=value;this.onAfterChange();}}});Object.defineProperty(this,'fillStyle',{get:function(){return hidden.fillStyle;},set:function(value){if(hidden.fillStyle!==value){hidden.fillStyle=value;this.onAfterChange();}}});Object.defineProperty(this,'strokeStyle',{get:function(){return hidden.strokeStyle;},set:function(value){if(hidden.strokeStyle!==value){hidden.strokeStyle=value;this.onAfterChange();}}});Object.defineProperty(this,'lineWidth',{get:function(){return hidden.lineWidth;},set:function(value){if(hidden.lineWidth!==value){hidden.lineWidth=value;this.onAfterChange();}}});this.set(x,y,width,height);},parseOffsetGlobal:function(offset){ret=new Math.Vector();if([OFFSET_TOP_LEFT,OFFSET_MIDDLE_LEFT,OFFSET_BOTTOM_LEFT].indexOf(offset)!==-1){ret.x=-this.lineWidth/2;}
else if([OFFSET_TOP_CENTER,OFFSET_MIDDLE_CENTER,OFFSET_BOTTOM_CENTER].indexOf(offset)!==-1){ret.x=this.width/2;}
else if([OFFSET_TOP_RIGHT,OFFSET_MIDDLE_RIGHT,OFFSET_BOTTOM_RIGHT].indexOf(offset)!==-1){ret.x=this.width+this.lineWidth/2;}
if([OFFSET_TOP_LEFT,OFFSET_TOP_CENTER,OFFSET_TOP_RIGHT].indexOf(offset)!==-1){ret.y=-this.lineWidth/2;}
else if([OFFSET_MIDDLE_LEFT,OFFSET_MIDDLE_CENTER,OFFSET_MIDDLE_RIGHT].indexOf(offset)!==-1){ret.y=this.height/2;}
else if([OFFSET_BOTTOM_LEFT,OFFSET_BOTTOM_CENTER,OFFSET_BOTTOM_RIGHT].indexOf(offset)!==-1){ret.y=this.height+this.lineWidth/2;}
return ret;},getRedrawRegion:function(){var ln;var rect=this.copy();ln=Math.ceil(this.lineWidth/2);rect.x-=ln;rect.y-=ln;rect.width+=ln*2;rect.height+=ln*2;return rect.add(this.parent.getRoomPosition());},});new Class('View.Polygon',[Math.Polygon,View.Child],{Polygon:function(points,fillStyle,strokeStyle,lineWidth){this.Child();this.renderType="polygon";this.setFromPoints(points);this.fillStyle=fillStyle||"#000";this.strokeStyle=strokeStyle||"#000";this.lineWidth=lineWidth||1;this.opacity=1;this.closed=1;this.lineDash=[];},getRedrawRegion:function(){var ln;var rect=this.getBoundingRectangle();ln=Math.ceil(this.lineWidth/2);rect.x-=ln;rect.y-=ln;rect.width+=ln*2;rect.height+=ln*2;return rect.add(this.parent.getRoomPosition());},});new Class('View.Container',[View.Child],{Container:function(child1,child2,child3){this.children=[];this.Child();this.parent=undefined;this.addChildren.apply(this,Array.prototype.slice.call(arguments));},addChildren:function(child1,child2){if(arguments.length===0){return;}
var i,child;for(i=0;i<arguments.length;i++){child=arguments[i];if(child.parent){child.parent.removeChildren(child);}
this.children.push(child);child.parent=this;engine.enableRedrawRegions&&child.onAfterChange();if(child.refreshSource){child.refreshSource();}}
return arguments;},insertBelow:function(insertChildren,child){var arr,i;if(!Array.prototype.isPrototypeOf(insertChildren)){arr=[];arr.push(insertChildren);insertChildren=arr;}
if((i=this.children.indexOf(child))!==-1){this.children.splice.apply(this.children,[i,0].concat(insertChildren));}
for(i=0;i<insertChildren.length;i++){child=insertChildren[i];if(child.parent){child.parent.removeChildren(child);}
child.parent=this;engine.enableRedrawRegions&&child.onAfterChange();if(child.refreshSource){child.refreshSource();}}
return insertChildren;},getChildren:function(){var ret,i;ret=[];for(i=0;i<this.children.length;i++){ret.push(this.children[i]);}
return ret;},setTheme:function(themeName,recursive){if(themeName){}
else{themeName=undefined;}
var i;recursive=recursive!==undefined?recursive:false;this.theme=themeName;if(this.refreshSource){this.refreshSource();}
if(recursive){for(i=0;i<this.children.length;i++){this.children[i].setTheme(undefined,true);}}
else{this.applyToThisAndChildren(function(){if(this.refreshSource){this.refreshSource();}});}},applyToThisAndChildren:function(func){var i;func.call(this);for(i=0;i<this.children.length;i++){if(this.children[i].applyToThisAndChildren){this.children[i].applyToThisAndChildren(func);}
else{func.call(this.children[i]);}}},getCombinedRedrawRegion:function(){var box,addBox,i,child;if(this.getRedrawRegion){box=this.getRedrawRegion();}
for(i=0;i<this.children.length;i++){child=this.children[i];if(child.getCombinedRedrawRegion){addBox=child.getCombinedRedrawRegion();}
else{addBox=child.getRedrawRegion();}
child.currentRedrawRegion=addBox;if(addBox){if(box){box=box.getBoundingRectangle(addBox);}
else{box=addBox;}}}
return box;},removeChildren:function(child1,child2){var i,childId,removed;removed=[];i=arguments.length;while(i>-1){childId=this.children.indexOf(arguments[i]);if(childId!==-1){this.children.splice(childId,1);removed.push(arguments[i]);arguments[i].parent=undefined;}
i--;}
return removed;},removeAllChildren:function(purge){purge=purge!==undefined?purge:true;var rmChild;rmChild=this.children.splice(0,this.children.length);rmChild.forEach(function(){this.parent=undefined;if(purge){engine.purge(this);}});},draw:function(c,area,noCache){if(engine.enableRedrawRegions){this.drawRedrawRegions(c,area);}
else{this.drawWholeCanvas(c,noCache);}},drawWholeCanvas:function(c,noCache){var i,len,child;if(!this.isVisible()){return;}
this.transformCanvasContext(c);if(this.drawCacheEnabled&&!noCache){c.drawImage(this.drawCacheCanvas,0,0);}
else{if(this.drawCanvas){this.drawCanvas(c);}
len=this.children.length;for(i=0;i<len;i++){child=this.children[i];if(child.draw){child.draw(c);}
else if(child.isVisible()){child.transformCanvasContext(c);child.drawCanvas(c);child.restoreCanvasContext(c);}}}
this.restoreCanvasContext(c);},drawCanvas:undefined,getRedrawRegion:undefined});new Class('View.Sprite',[View.Container,Lib.Animatable],{Sprite:function(source,x,y,direction,additionalProperties){var offset;this.Container();this.renderType="sprite";this.x=x!==undefined?x:0;this.y=y!==undefined?y:0;this.source=source;this.direction=direction!==undefined?direction:0;this.imageNumber=0;this.imageLength=1;this.animationSpeed=30;this.animationLastSwitch=engine.gameTime;this.animationLoops=true;this.clipWidth;this.clipHeight;Object.defineProperty(this,'width',{get:function(){return Math.abs(this.clipWidth*this.size*this.widthScale);},set:function(value){var sign=this.widthScale>0?1:-1;this.widthScale=sign*Math.abs(value/(this.clipWidth*this.size));return value;}});Object.defineProperty(this,'height',{get:function(){return Math.abs(this.clipHeight*this.size*this.heightScale);},set:function(value){var sign=this.heightScale>0?1:-1;this.heightScale=sign*Math.abs(value/(this.clipHeight*this.size));return value;}});offset=OFFSET_MIDDLE_CENTER;if(additionalProperties&&additionalProperties.offset){offset=additionalProperties.offset;delete additionalProperties.offset;}
this.importProperties(additionalProperties);if(!this.refreshSource()){}
this.offset=offset;if(engine.avoidSubPixelRendering){this.offset.x=Math.round(this.offset.x);this.offset.y=Math.round(this.offset.y);}},parseOffsetGlobal:function(offset){ret=new Math.Vector();if([OFFSET_TOP_LEFT,OFFSET_MIDDLE_LEFT,OFFSET_BOTTOM_LEFT].indexOf(offset)!==-1){ret.x=0;}
else if([OFFSET_TOP_CENTER,OFFSET_MIDDLE_CENTER,OFFSET_BOTTOM_CENTER].indexOf(offset)!==-1){ret.x=this.bm.width/this.imageLength/2;}
else if([OFFSET_TOP_RIGHT,OFFSET_MIDDLE_RIGHT,OFFSET_BOTTOM_RIGHT].indexOf(offset)!==-1){ret.x=this.bm.width/this.imageLength;}
if([OFFSET_TOP_LEFT,OFFSET_TOP_CENTER,OFFSET_TOP_RIGHT].indexOf(offset)!==-1){ret.y=0;}
else if([OFFSET_MIDDLE_LEFT,OFFSET_MIDDLE_CENTER,OFFSET_MIDDLE_RIGHT].indexOf(offset)!==-1){ret.y=this.bm.height/2;}
else if([OFFSET_BOTTOM_LEFT,OFFSET_BOTTOM_CENTER,OFFSET_BOTTOM_RIGHT].indexOf(offset)!==-1){ret.y=this.bm.height;}
return ret;},getTheme:function(){var parent,theme;theme=this.theme;parent=this;while(theme===undefined){if(parent.theme){theme=parent.theme;}
else{if(parent.parent){parent=parent.parent;}
else{break;}}}
return theme?theme:engine.defaultTheme;},refreshSource:function(){var theme;theme=this.getTheme();this.bm=loader.getImage(this.source,theme);this.imageLength=this.bm.imageLength;this.imageNumber=Math.min(this.imageLength-1,this.imageNumber);this.clipWidth=Math.floor(this.bm.width/this.imageLength);this.clipHeight=this.bm.height;if(this.offsetGlobal){this.offset=this.offsetGlobal;}
return this.bm;},setSource:function(source){if(this.source===source){return;}
this.source=source;this.refreshSource();},getRedrawRegion:function(){var box,parents,parent,i;box=new Math.Rectangle(-this.offset.x,-this.offset.y,this.clipWidth,this.clipHeight).getPolygon();parents=this.getParents();parents.unshift(this);for(i=0;i<parents.length;i++){parent=parents[i];box.scale(parent.size*parent.widthScale,parent.size*parent.heightScale);box.rotate(parent.direction);box.move(parent.x,parent.y);}
box=box.getBoundingRectangle();box.x=Math.floor(box.x);box.y=Math.floor(box.y);box.width=Math.ceil(box.width+1);box.height=Math.ceil(box.height+1);return box;}});new Class('View.Collidable',[View.Sprite],{Collidable:function(source,x,y,direction,additionalProperties){this.Sprite(source,x,y,direction,additionalProperties);this.mask=this.mask?this.mask:loader.getMask(source,this.getTheme());this.collisionResolution=this.collisionResolution?this.collisionResolution:engine.defaultCollisionResolution;},boundingBoxCollidesWith:function(objects,getCollidingObjects){if(!Array.prototype.isPrototypeOf(objects)){objects=[objects];}
getCollidingObjects=getCollidingObjects!==undefined?getCollidingObjects:false;var pol1,pol2,i,collidingObjects,obj;pol1=this.getTransformedBoundingBox();collidingObjects=[];for(i=0;i<objects.length;i++){obj=objects[i];pol2=obj.getTransformedBoundingBox();if(pol1.intersects(pol2)||pol1.contains(pol2.points[0])||pol2.contains(pol1.points[0])){if(getCollidingObjects){collidingObjects.push(obj);}
else{return true;}}}
if(collidingObjects.length){return collidingObjects;}
else{return false;}},getTransformedBoundingBox:function(){var box,parents,parent,i;box=this.mask.bBox.copy().move(-this.offset.x,-this.offset.y);parents=this.getParents();parents.unshift(this);for(i=0;i<parents.length;i++){parent=parents[i];if(parent.size!==1||parent.widthScale!==1||parent.heightScale!==1){box.scale(parent.size*parent.widthScale,parent.size*parent.heightScale);}
if(parent.direction!==0){box.rotate(parent.direction);}
if(parent.x!==0||parent.y!==0){box.move(parent.x,parent.y);}}
return box;},maskCollidesWith:function(objects,getCollisionPosition){var canvas,mask,ctx,roomPos,parents,obj,bitmap,i,ii,data,length,pixel,pxArr,x,y,avX,avY,retVector;if(!Array.prototype.isPrototypeOf(objects)){objects=[objects];}
getCollisionPosition=getCollisionPosition!==undefined?getCollisionPosition:false;mask=this.mask;canvas=document.createElement('canvas');canvas.width=Math.ceil(this.clipWidth);canvas.height=Math.ceil(this.clipHeight);canvas.id='colCanvas';c=canvas.getContext('2d');c.fillStyle="#FFF";c.fillRect(0,0,canvas.width,canvas.height);c.save();c.translate(this.offset.x,this.offset.y);parents=this.getParents();parents.unshift(this);for(i=0;i<parents.length;i++){Renderer.Canvas.prototype.restoreCanvasContext(parents[i],c);}
for(i=0;i<objects.length;i++){obj=objects[i];if(obj===this){continue;}
parents=obj.getParents();parents.reverse();parents.push(obj);parents.forEach(function(){Renderer.Canvas.prototype.transformCanvasContext(this,c);})
c.drawImage(obj.mask,(obj.clipWidth+obj.bm.spacing)*obj.imageNumber,0,obj.clipWidth,obj.clipHeight,-obj.offset.x,-obj.offset.y,obj.clipWidth,obj.clipHeight);parents.reverse();parents.forEach(function(){Renderer.Canvas.prototype.restoreCanvasContext(this,c);});}
c.restore();c.globalAlpha=0.5;c.fillRect(0,0,canvas.width,canvas.height);c.translate(canvas.width/2,canvas.height/2);c.drawImage(mask,(this.clipWidth+this.bm.spacing)*this.imageNumber,0,this.clipWidth,this.clipHeight,-this.clipWidth/2,-this.clipHeight/2,this.clipWidth,this.clipHeight);bitmap=c.getImageData(0,0,canvas.width,canvas.height);data=bitmap.data;length=data.length/4;pxArr=[];for(pixel=0;pixel<length;pixel+=this.collisionResolution){x=pixel%bitmap.width;if(this.collisionResolution>1&&x<this.collisionResolution){y=Math.floor(pixel/bitmap.width);pixel-=x;if(y%2){pixel+=Math.floor(this.collisionResolution/2);}}
if(data[pixel*4]<127){if(getCollisionPosition){if(y===undefined){y=Math.floor(pixel/bitmap.width);}
pxArr.push({x:x,y:y});}
else{return true;}}}
if(pxArr.length>0){pxArr=pxArr.sortByNumericProperty('x');avX=(pxArr[0].x+pxArr[pxArr.length-1].x)/2;pxArr=pxArr.sortByNumericProperty('y');avY=(pxArr[0].y+pxArr[pxArr.length-1].y)/2;avX-=this.offset.x;avY-=this.offset.y;avX/=this.size*this.widthScale;avY/=this.size*this.heightScale;retVector=new Math.Vector(avX,avY);retVector.rotate(this.direction);retVector.pixelCount=pxArr.length;return retVector;}
return false;},collidesWith:function(objects,getCollisionPosition,getCollidingObjects){var ret,i,position;if(!Array.prototype.isPrototypeOf(objects)){objects=[objects];}
getCollidingObjects=getCollidingObjects!==undefined?getCollidingObjects:false;if(this.size===0||this.widthScale===0||this.heightScale===0){return false;}
objects=this.boundingBoxCollidesWith(objects,true);if(objects===false){return false;}
if(!getCollisionPosition&&!getCollidingObjects){return this.maskCollidesWith(objects);}
else{ret={objects:[],positions:[],combinedPosition:false};if(getCollidingObjects===false){position=this.maskCollidesWith(objects,true);if(position){ret.positions.push(position);ret.combinedPosition=position.copy();ret.combinedPosition.pixelCount=0;}}
else{if(getCollisionPosition){for(i=0;i<objects.length;i++){position=this.maskCollidesWith(objects[i],true);if(position){ret.objects.push(objects[i]);ret.positions.push(position);}}
if(ret.positions.length){ret.combinedPosition=new Math.Vector();ret.combinedPosition.pixelCount=0;ret.positions.forEach(function(){ret.combinedPosition.add(this.scale(this.pixelCount));ret.combinedPosition.pixelCount+=this.pixelCount;});ret.combinedPosition.scale(1/ret.combinedPosition.pixelCount);}}
else{for(i=0;i<objects.length;i++){if(this.maskCollidesWith(objects[i])){ret.objects.push(objects[i]);}}}}}
if(ret.positions.length+ret.objects.length!==0){return ret;}
else{return false;}},drawBoundingBox:function(c){var pol;pol=this.mask.bBox.copy().move(-this.offset.x,-this.offset.y);c.beginPath();c.moveTo(pol.points[0].x,pol.points[0].y);c.lineTo(pol.points[1].x,pol.points[1].y);c.lineTo(pol.points[2].x,pol.points[2].y);c.lineTo(pol.points[3].x,pol.points[3].y);c.closePath();c.strokeStyle="#0F0";c.lineWidth=1;c.stroke();},drawMask:function(c){if(!this.mask){return;}
try{c.drawImage(this.mask,(this.clipWidth+this.bm.spacing)*this.imageNumber,0,this.clipWidth,this.clipHeight,-this.offset.x,-this.offset.y,this.clipWidth,this.clipHeight);}catch(e){;;engine.stopMainLoop();throw new Error(e);}
1}});new Class('View.TextBlock',[Lib.Animatable,View.Container],{TextBlock:function(string,x,y,width,additionalProperties){var hidden,offset;this.Container();this.renderType="textblock";this.x=x!==undefined?x:0;this.y=y!==undefined?y:0;this.imageLength=1;this.imageNumber=0;this.clipWidth=parseInt(width,10)||200;this.lines=[];this.lineWidth=[];this.bm=document.createElement('canvas');this.bmCtx=this.bm.getContext('2d');this.bm.width=this.clipWidth;this.bm.height=10;this.bm.spacing=0;hidden={string:'',font:'normal 14px Verdana',alignment:'left',color:"#000000",lineHeight:0,};Object.defineProperty(this,'string',{get:function(){return hidden.string;},set:function(value){hidden.string=typeof value==='string'?value:value.toString();this.stringToLines();this.cacheRendering();engine.enableRedrawRegions&&this.onAfterChange();return value;}});Object.defineProperty(this,'font',{get:function(){return hidden.font;},set:function(value){if(value===hidden.font){return value;}
hidden.font=value;this.stringToLines();this.cacheRendering();engine.enableRedrawRegions&&this.onAfterChange();return value;}});Object.defineProperty(this,'alignment',{get:function(){return hidden.alignment;},set:function(value){if(value===hidden.alignment){return value;}
hidden.alignment=value;this.cacheRendering();engine.enableRedrawRegions&&this.onAfterChange();return value;}});Object.defineProperty(this,'color',{get:function(){return hidden.color;},set:function(value){if(value===hidden.color){return value;}
hidden.color=value;this.cacheRendering();engine.enableRedrawRegions&&this.onAfterChange();return value;}});Object.defineProperty(this,'lineHeight',{get:function(){return hidden.lineHeight;},set:function(value){hidden.lineHeight=typeof value!=="number"?value:parseFloat(value);this.calculateCanvasHeight();this.cacheRendering();engine.enableRedrawRegions&&this.onAfterChange();return value;}});Object.defineProperty(this,'width',{get:function(){return Math.abs(this.clipWidth*this.size*this.widthScale);},set:function(value){var sign=this.widthScale>0?1:-1;this.widthScale=sign*Math.abs(value/(this.clipWidth*this.size));return value;}});Object.defineProperty(this,'height',{get:function(){return Math.abs(this.clipHeight*this.size*this.heightScale);},set:function(value){var sign=this.heightScale>0?1:-1;this.heightScale=sign*Math.abs(value/(this.clipHeight*this.size));return value}});this.lineHeight=additionalProperties&&additionalProperties.lineHeight?additionalProperties.lineHeight:this.font.match(/[0.0-9]+/)*1.25;offset=OFFSET_TOP_LEFT;if(additionalProperties&&additionalProperties.offset){offset=additionalProperties.offset;delete additionalProperties.offset;}
this.importProperties(additionalProperties);this.string=string;this.offset=offset;if(engine.avoidSubPixelRendering){this.offset.x=Math.round(this.offset.x);this.offset.y=Math.round(this.offset.y);}},parseOffsetGlobal:function(offset){ret=new Math.Vector();if([OFFSET_TOP_LEFT,OFFSET_MIDDLE_LEFT,OFFSET_BOTTOM_LEFT].indexOf(offset)!==-1){ret.x=0;}
else if([OFFSET_TOP_CENTER,OFFSET_MIDDLE_CENTER,OFFSET_BOTTOM_CENTER].indexOf(offset)!==-1){ret.x=this.clipWidth/2;}
else if([OFFSET_TOP_RIGHT,OFFSET_MIDDLE_RIGHT,OFFSET_BOTTOM_RIGHT].indexOf(offset)!==-1){ret.x=this.clipWidth;}
if([OFFSET_TOP_LEFT,OFFSET_TOP_CENTER,OFFSET_TOP_RIGHT].indexOf(offset)!==-1){ret.y=0;}
else if([OFFSET_MIDDLE_LEFT,OFFSET_MIDDLE_CENTER,OFFSET_MIDDLE_RIGHT].indexOf(offset)!==-1){ret.y=this.clipHeight/2;}
else if([OFFSET_BOTTOM_LEFT,OFFSET_BOTTOM_CENTER,OFFSET_BOTTOM_RIGHT].indexOf(offset)!==-1){ret.y=this.clipHeight;}
return ret;},stringToLines:function(){var lt,line,paragraphs,pid,words,wid,word;lt=document.createElement('span');lt.style.font=this.font;lt.style.visibility='hidden';lt.style.position='absolute';document.body.appendChild(lt);line=0;this.lines=[];this.lines[line]='';paragraphs=this.string.split("\n");for(pid=0;pid<paragraphs.length;pid++){words=paragraphs[pid].split(' ');lt.innerHTML='';this.lines[line]='';for(wid=0;wid<words.length;wid++){word=words[wid];lt.innerHTML+=word+" ";if(lt.offsetWidth>this.clipWidth){line++;this.lines[line]='';lt.innerHTML='';lt.innerHTML+=word+" ";this.lineWidth[line]=lt.offsetWidth;}
else{this.lineWidth[line]=lt.offsetWidth;}
this.lines[line]+=word+" ";}
line++;}
this.calculateCanvasHeight();lt.parentNode.removeChild(lt);},calculateCanvasHeight:function(){this.bm.height=(this.lines.length-1)*this.lineHeight+this.font.match(/[0.0-9]+/)*1.25;this.clipHeight=this.bm.height;},cacheRendering:function(){var xOffset,i;this.bmCtx.clearRect(0,0,this.bm.width,this.bm.height);this.bmCtx.font=this.font;this.bmCtx.fillStyle=this.color;for(i=0;i<this.lines.length;i++){xOffset=0;switch(this.alignment){case'left':xOffset=0;break;case'right':xOffset=this.clipWidth-this.lineWidth[i];break;case'center':xOffset=(this.clipWidth-this.lineWidth[i])/2;break;}
if(this.lines[i]){this.bmCtx.fillText(this.lines[i],xOffset,this.lineHeight*i+this.font.match(/[0.0-9]+/)*1);}}
this.createHash();},createHash:function(){var self;self=this;this.bm.oldSrc=this.bm.src;this.bm.src=['string','font','alignment','color','lineHeight','clipWidth'].map(function(property){return self[property];}).join('-|-');},isVisible:function(){return!(this.size===0||this.widthScale===0||this.heightScale===0||/^\s*$/.test(this.string));},getRedrawRegion:function(){var ret;ret=new Math.Rectangle(-this.offset.x,-this.offset.y,this.clipWidth,this.clipHeight);ret=ret.getPolygon();ret=ret.scale(this.size*this.widthScale,this.size*this.heightScale);ret=ret.rotate(this.direction);ret=ret.getBoundingRectangle().add(this.getRoomPosition());ret.x=Math.floor(ret.x-1);ret.y=Math.floor(ret.y-1);ret.width=Math.ceil(ret.width+2);ret.height=Math.ceil(ret.height+2);return ret;}});new Class('View.GameObject',[View.Collidable],{GameObject:function(source,x,y,direction,additionalProperties){this.Collidable(source,x,y,direction,additionalProperties);this.loop=this.loop?this.loop:engine.defaultActivityLoop;this.loop.attachFunction(this,this.updatePosition);this.speed=this.speed?this.speed:new Math.Vector(0,0);this.alive=true;},updatePosition:function(){if(this.alive){this.x+=engine.convertSpeed(this.speed.x);this.y+=engine.convertSpeed(this.speed.y);}}});new Class('Engine.Room',[View.Container],{Room:function(name,onEntered,onLeft){this.Container();this.name=name?name:engine.roomList.length;this.onEntered=onEntered!==undefined?onEntered:function(){};this.onLeft=onLeft!==undefined?onLeft:function(){};this.loops={};this.paused=false;this.addLoop('eachFrame',new Engine.CustomLoop());engine.addRoom(this);},pause:function(){this.paused=true;},play:function(){this.paused=false;},update:function(){if(this.paused){return;}
var i;for(i in this.loops){if(this.loops.hasOwnProperty(i)){this.loops[i].execute();}}},addLoop:function(name,loop){this.loops[name]=loop;},removeLoop:function(name){delete this.loops[name];},remove:undefined});new Class('Engine.Camera',{Camera:function(captureRegion,projectionRegion,room){this.captureRegion=captureRegion;this.projectionRegion=projectionRegion;this.room=room||engine.currentRoom;},});new Class('Engine.CustomLoop',{CustomLoop:function(framesPerExecution,maskFunction){this.framesPerExecution=framesPerExecution===undefined?1:framesPerExecution;this.maskFunction=maskFunction===undefined?function(){return true;}:maskFunction;this.functionsQueue=[];this.functions=[];this.executionsQueue=[];this.executions=[];this.animations=[];this.lastFrame=engine.frames;this.last=engine.now?engine.now:new Date().getTime();this.time=0;this.execTime=0;},attachFunction:function(caller,func){this.functionsQueue.push({object:caller,activity:func});},addFunctionsQueue:function(){this.functions=this.functions.concat(this.functionsQueue);this.functionsQueue=[];},detachFunction:function(caller,func){var i,a;for(i=0;i<this.functions.length;i++){a=this.functions[i];if(a.object===caller&&a.activity===func){this.functions.splice(i,1);return true;}}
for(i=0;i<this.functionsQueue.length;i++){a=this.functionsQueue[i];if(a.object===caller&&a.activity===func){this.functionsQueue.splice(i,1);return true;}}
return false;},detachFunctionsByFunction:function(func){var removeArray,i;removeArray=[];i=this.functions.length;while(i--){if(func===this.functions[i].func){removeArray.push(this.functions.splice(i,1));}}
i=this.functionsQueue.length;while(i--){if(func===this.functions[i].func){removeArray.push(this.functionsQueue.splice(i,1));}}
if(removeArray.length){return removeArray;}
else{return false;}},detachFunctionsByCaller:function(caller){var removeArray,i;removeArray=[];i=this.functions.length;while(i--){if(caller===this.functions[i].object){removeArray.push(this.functions.splice(i,1));}}
i=this.functionsQueue.length;while(i--){if(caller===this.functionsQueue[i].object){removeArray.push(this.functionsQueue.splice(i,1));}}
if(removeArray.length){return removeArray;}
else{return false;}},schedule:function(caller,func,delay){this.executionsQueue.push({func:func,execTime:this.time+delay,caller:caller});},addExecutionsQueue:function(){this.executions=this.executions.concat(this.executionsQueue);this.executionsQueue=[];},unschedule:function(caller,func){var i,exec;for(i=0;i<this.executions.length;i++){exec=this.executions[i];if(caller===exec.caller&&(exec.func===func||exec.func.toString()===func)){this.executions.splice(i,1);return true;}}
for(i=0;i<this.executionsQueue.length;i++){exec=this.executionsQueue[i];if(caller===exec.caller&&(exec.func===func||exec.func.toString()===func)){this.executionsQueue.splice(i,1);return true;}}
return false;},unscheduleByFunction:function(func){var unscheduledArray,i,exec;unscheduledArray=[];i=this.executions.length;while(i--){exec=this.executions[i];if(func===exec.func){unscheduledArray.push(this.executions.splice(i,1));}}
i=this.executionsQueue.length;while(i--){exec=this.executionsQueue[i];if(func===exec.func){unscheduledArray.push(this.executionsQueue.splice(i,1));}}
if(unscheduledArray.length){return unscheduledArray;}
else{return false;}},unscheduleByCaller:function(caller){var unscheduledArray,i,exec;unscheduledArray=[];i=this.executions.length;while(i--){exec=this.executions[i];if(caller===exec.caller){unscheduledArray.push(this.executions.splice(i,1));}}
i=this.executionsQueue.length;while(i--){exec=this.executionsQueue[i];if(caller===exec.caller){unscheduledArray.push(this.executionsQueue.splice(i,1));}}
if(unscheduledArray.length){return unscheduledArray;}
else{return false;}},unscheduleAll:function(){var removeArray;removeArray=[].concat(this.executions,this.executionsQueue);this.executions=[];this.executionsQueue=[];return removeArray;},addAnimation:function(animation){var anim,propList,currentAnimations,i,cur,propName;anim=animation;anim.start=this.time;propList=Object.keys(anim.prop);currentAnimations=anim.obj.getAnimations();for(i=0;i<currentAnimations.length;i++){cur=currentAnimations[i];for(propName in cur.prop){if(cur.prop.hasOwnProperty(propName)){if(propList.indexOf(propName)!==-1){delete cur.prop[propName];}}}}
this.animations.push(anim);},removeAnimationsOfObject:function(object){var i;i=this.animations.length;while(i--){if(object===this.animations[i].obj){this.animations.splice(i,1);}}},updateAnimations:function(){var animId,a,propId,t;for(animId=this.animations.length-1;animId>-1;animId--){a=this.animations[animId];if(a===undefined){continue;}
t=this.time-a.start;if(t>a.duration){this.animations.splice(animId,1);for(propId in a.prop){if(a.prop.hasOwnProperty(propId)){a.obj[propId]=a.prop[propId].end;}}
if(typeof a.callback==="string"){eval(a.callback);}else{a.callback.call(a.obj);}}else{for(propId in a.prop){if(a.prop.hasOwnProperty(propId)){a.obj[propId]=engine.ease(a.easing,t,a.prop[propId].begin,a.prop[propId].end-a.prop[propId].begin,a.duration);}}}
a.onStep&&a.onStep();}},execute:function(){var timer,i,exec;timer=new Date().getTime();if(!this.maskFunction()||engine.frames%this.framesPerExecution){return;}
if(engine.frames-this.lastFrame===this.framesPerExecution){this.time+=engine.gameTimeIncrease;}
this.lastFrame=engine.frames;this.last=engine.now;this.updateAnimations();i=this.executions.length;while(i--){if(i>=this.executions.length){continue;}
exec=this.executions[i];if(this.time>=exec.execTime){exec.func.call(exec.caller);this.executions.splice(i,1);}}
for(i=0;i<this.functions.length;i++){exec=this.functions[i];exec.activity.call(exec.object);}
this.addFunctionsQueue();this.addExecutionsQueue();this.execTime=(new Date().getTime())-timer;}});new Class('Input.Keyboard',{Keyboard:function(){var key;document.addEventListener('keydown',function(event){keyboard.onKeyDown(event);if(engine.preventDefaultKeyboard){event.preventDefault();}},false);document.addEventListener('keyup',function(event){keyboard.onKeyUp(event);if(engine.preventDefaultKeyboard){event.preventDefault();}},false);this.keys=new Array(200);for(key=0;key<this.keys.length;key++){this.keys[key]={events:[]};}},onKeyDown:function(event){var key;if(!this.isDown(event.keyCode)){key=this.keys[event.keyCode];key.events=key.events.slice(0,1);key.events.unshift(new Date().getTime());}},onKeyUp:function(event){var key;if(this.isDown(event.keyCode)){key=this.keys[event.keyCode];key.events=key.events.slice(0,1);key.events.unshift(-new Date().getTime());}},isDown:function(key){if(typeof key==='string'){key=key.toUpperCase().charCodeAt(0);}
return this.keys[key].events.length&&this.keys[key].events[0]>0;},isPressed:function(key){if(typeof key==='string'){key=key.toUpperCase().charCodeAt(0);}
return this.keys[key].events.length&&this.keys[key].events[0]>engine.last;},isReleased:function(key){if(typeof key==='string'){key=key.toUpperCase().charCodeAt(0);}
return this.keys[key].events.length&&-this.keys[key].events[0]>engine.last;}});new Class('Input.Pointer',{Pointer:function(){var button;if(engine.host.hasTouch){document.addEventListener('touchstart',function(event){pointer.onTouchStart(event);},false);document.addEventListener('touchend',function(event){pointer.onTouchEnd(event);},false);document.addEventListener('touchmove',function(event){pointer.onTouchMove(event);},false);}
else{document.addEventListener('mousedown',function(event){pointer.onMouseDown(event);},false);document.addEventListener('mouseup',function(event){pointer.onMouseUp(event);},false);document.addEventListener('mousemove',function(event){engine.host.hasMouse=true;pointer.onMouseMove(event);},false);}
this.mouse=new Math.Vector();this.mouse.window=new Math.Vector();this.mouse.buttons=new Array(11);for(button=0;button<this.mouse.buttons.length;button++){this.mouse.buttons[button]=new Math.Vector();this.mouse.buttons[button].events=new Array(2);}
this.mouse.lastMoved=0;this.touches=new Array(10);for(button=0;button<this.touches.length;button++){this.touches[button]=new Math.Vector();this.touches[button].x=undefined;this.touches[button].y=undefined;this.touches[button].events=new Array(2);}},onMouseDown:function(event){var button;this.onMouseMove(event);if(!this.isDown(event.which)){button=this.mouse.buttons[event.which];button.events=button.events.slice(0,1);button.events.unshift(new Date().getTime());}},onMouseUp:function(event){var button;this.onMouseMove(event);if(this.isDown(event.which)){button=this.mouse.buttons[event.which];button.events=button.events.slice(0,1);button.events.unshift(-new Date().getTime());}},onMouseMove:function(event){var roomPos;this.mouse.window.set(event.pageX,event.pageY);this.mouse.set(this.mouse.window.x-engine.arena.offsetLeft-engine.canvas.offsetLeft+document.body.scrollLeft,this.mouse.window.y-engine.arena.offsetTop-engine.canvas.offsetTop+document.body.scrollTop);this.mouse.x=this.mouse.x/engine.arena.offsetWidth*engine.canvasResX;this.mouse.y=this.mouse.y/engine.arena.offsetHeight*engine.canvasResY;roomPos=this.calculateRoomPosition(this.mouse);this.mouse.x=roomPos.x;this.mouse.y=roomPos.y;this.mouse.buttons.forEach(function(){this.x=pointer.mouse.x;this.y=pointer.mouse.y;});this.mouse.lastMoved=new Date().getTime();if(this.cursor){this.cursor.x=this.mouse.x;this.cursor.y=this.mouse.y;}},onTouchStart:function(event){var i,eventTouch,pointerTouch,touchNumber;for(i=0;i<event.changedTouches.length;i++){if(i!=="length"){eventTouch=event.changedTouches[i];if(event.changedTouches[i].identifier>20){touchNumber=this.findTouchNumber();}
else{touchNumber=eventTouch.identifier;}
pointerTouch=this.touches[touchNumber];pointerTouch.identifier=eventTouch.identifier;pointerTouch.events=pointerTouch.events.slice(0,1);pointerTouch.events.unshift(new Date().getTime());}}
this.onTouchMove(event);},onTouchEnd:function(event){var i,eventTouch,pointerTouch;for(i=0;i<event.changedTouches.length;i++){eventTouch=event.changedTouches[i];if(event.changedTouches[i].identifier>20){pointerTouch=this.touches.getElementByPropertyValue('identifier',eventTouch.identifier);}
else{pointerTouch=this.touches[eventTouch.identifier];}
pointerTouch.events=pointerTouch.events.slice(0,1);pointerTouch.events.unshift(-new Date().getTime());}
this.onTouchMove(event);},onTouchMove:function(event){var i,eventTouch,pointerTouch,roomPos;for(i=0;i<event.touches.length;i++){eventTouch=event.touches[i];if(event.touches[i].identifier>20){pointerTouch=this.touches.getElementByPropertyValue('identifier',eventTouch.identifier);}
else{pointerTouch=this.touches[eventTouch.identifier];}
pointerTouch.set(eventTouch.pageX-engine.arena.offsetLeft-engine.canvas.offsetLeft+document.body.scrollLeft,eventTouch.pageY-engine.arena.offsetTop-engine.canvas.offsetTop+document.body.scrollTop);pointerTouch.x=pointerTouch.x/engine.arena.offsetWidth*engine.canvasResX;pointerTouch.y=pointerTouch.y/engine.arena.offsetHeight*engine.canvasResY;roomPos=this.calculateRoomPosition(pointerTouch);pointerTouch.x=roomPos.x;pointerTouch.y=roomPos.y;}},mouseHasMoved:function(){return engine.last<this.mouse.lastMoved;},isDown:function(button){var pointers;switch(this.getButtonType(button)){case"mouse":pointers=button===MOUSE_ANY?this.mouse.buttons:this.mouse.buttons[button];break;case"touch":pointers=button===TOUCH_ANY?this.touches:this.touches[button-TOUCH_1];break;case"any":pointers=this.mouse.buttons.concat(this.touches);}
return this.checkPointer(pointers,"down");},isPressed:function(button){var pointers;switch(this.getButtonType(button)){case"mouse":pointers=button===MOUSE_ANY?this.mouse.buttons:this.mouse.buttons[button];break;case"touch":pointers=button===TOUCH_ANY?this.touches:this.touches[button-TOUCH_1];break;case"any":pointers=this.mouse.buttons.concat(this.touches);}
return this.checkPointer(pointers,"pressed");},isReleased:function(button){var pointers;switch(this.getButtonType(button)){case"mouse":pointers=button===MOUSE_ANY?this.mouse.buttons:this.mouse.buttons[button];break;case"touch":pointers=button===TOUCH_ANY?this.touches:this.touches[button-TOUCH_1];break;case"any":pointers=this.mouse.buttons.concat(this.touches);}
return this.checkPointer(pointers,"released");},shapeIsPressed:function(button,shape,outside){button=button!==undefined?button:MOUSE_TOUCH_ANY;var i,pointers,pointer,ret;pointers=this.isPressed(button);if(!pointers){return false;}
ret=[];for(i=0;i<pointers.length;i++){pointer=pointers[i];if(pointer.x===false||pointer.y===false){continue;}
if(!outside&&shape.contains(pointer)){ret.push(pointer);}
else if(outside&&!shape.contains(pointer)){ret.push(pointer);}}
return ret.length?ret:false;},shapeIsReleased:function(button,shape,outside){button=button!==undefined?button:MOUSE_TOUCH_ANY;var i,pointers,pointer,ret;pointers=this.isReleased(button);if(!pointers){return false;}
ret=[];for(i=0;i<pointers.length;i++){pointer=pointers[i];if(pointer.x===false||pointer.y===false){continue;}
if(!outside&&shape.contains(pointer)){ret.push(pointer);}
else if(outside&&!shape.contains(pointer)){ret.push(pointer);}}
return ret.length?ret:false;},shapeIsDown:function(button,shape,outside){button=button!==undefined?button:MOUSE_TOUCH_ANY;var i,pointers,pointer,ret;pointers=this.isDown(button);if(!pointers){return false;}
ret=[];for(i=0;i<pointers.length;i++){pointer=pointers[i];if(pointer.x===false||pointer.y===false){continue;}
if(!outside&&shape.contains(pointer)){ret.push(pointer);}
else if(outside&&!shape.contains(pointer)){ret.push(pointer);}}
return ret.length?ret:false;},getButtonType:function(button){if(button>=MOUSE_ANY&&button<=MOUSE_10){return"mouse";}
else if(button>=TOUCH_ANY&&button<=TOUCH_10){return"touch";}
else if(button===MOUSE_TOUCH_ANY){return"any";}},checkPointer:function(pointers,state){var i,pointer,ret;if(!Array.prototype.isPrototypeOf(pointers)){pointers=[pointers];}
ret=[];for(i=0;i<pointers.length;i++){pointer=pointers[i];switch(state){case"pressed":if(pointer.events[0]>engine.last||pointer.events[1]>engine.last){ret.push(pointer);}
break;case"released":if(-pointer.events[0]>engine.last||-pointer.events[1]>engine.last){ret.push(pointer);}
break;case"down":if(pointer.events[0]>0){ret.push(pointer);}
break;}}
return ret.length?ret:false;},calculateRoomPosition:function(vector){var ret,len,camera;ret=vector.copy();len=engine.cameras.length;while(len--){camera=engine.cameras[len];if(camera.projectionRegion.contains(vector)||len===0){ret.subtract(camera.projectionRegion);ret.x*=camera.captureRegion.width/camera.projectionRegion.width;ret.y*=camera.captureRegion.height/camera.projectionRegion.height;ret.add(camera.captureRegion);return ret;}}
return ret;},findTouchNumber:function(){var i;for(i=0;i<this.touches.length;i++){if(!this.checkPointer(this.touches[i],'down')){return i;}}
return false;},shapeIsHovered:function(shape,outside){if(!outside&&(shape.contains(this.mouse))){return true;}
else if(outside&&(!shape.contains(this.mouse))){return true;}
return false;},release:function(button){var i,pointers,events,unpressed;pointers=this.isPressed(button);if(!pointers){return false;}
for(i=0;i<pointers.length;i++){events=pointers[i].events;if(events[0]>engine.last){events.shift();events.push(undefined);unpressed=true;}
if(events[1]>engine.last){events.pop();events.push(undefined);unpressed=true;}}
return unpressed;},outside:function(){return new Math.Rectangle(engine.arena.offsetLeft,engine.arena.offsetTop,engine.arena.offsetWidth,engine.arena.offsetHeight).contains(this.mouse.window)===false;},resetCursor:function(){engine.arena.style.cursor='default';},setCursor:function(cursor){var resource;resource=loader.getImage(cursor);if(resource){cursor="url('"+resource.src+"') 0 0, auto";}
else if(!/^\w*$/.test(cursor)){cursor="url('"+cursor+"') 0 0, auto";}
engine.arena.style.cursor=cursor;}});new Class('Sound.Effect',{Effect:function(audioElement){var snd;this.source=audioElement;this.playbackId=0;this.elements=[];snd=this;this.source.addEventListener("canplaythrough",function(){snd.cacheCopies();},false);},cacheCopies:function(){var i;for(i=0;i<engine.cachedSoundCopies;i++){this.elements.push(this.source.cloneNode());this.elements[i].started=false;}},play:function(loop){var i,sound;if(engine.soundsMuted){return false;}
for(i=0;i<this.elements.length;i++){sound=this.elements[i];if((sound.started===false||sound.ended)&&!sound.loop){sound.started=true;sound.volume=1;sound.play();if(loop){sound.loop='loop';}
this.playbackId++;sound.playbackId=this.playbackId;return this.playbackId;}}
return false;},stop:function(playbackId){var i,sound;for(i=0;i<this.elements.length;i++){sound=this.elements[i];if(sound.playbackId===playbackId&&sound.started&&!sound.ended){sound.volume=0;sound.loop=false;return true;}}
return false;},stopAll:function(){var i,sound;for(i=0;i<this.elements.length;i++){sound=this.elements[i];if(sound.started&&!sound.ended){sound.volume=0;sound.loop=false;}}},stopLoop:function(playbackId){var i,sound;for(i=0;i<this.elements.length;i++){sound=this.elements[i];if(sound.playbackId===playbackId&&sound.started&&!sound.ended){sound.loop=false;return true;}}
return false;}});new Class('Sound.Music',{Music:function(audioElement){this.source=audioElement;this.paused=false;},play:function(loop){if(engine.musicMuted){return false;}
this.source.play();this.paused=false;if(loop){this.source.loop="loop";}
return true;},pause:function(){this.paused=true;this.source.pause();},stop:function(){if(!this.source.ended){this.source.pause();this.source.currentTime=0;this.source.loop=false;return true;}
return false;},stopLoop:function(){if(this.source.started&&!this.source.ended){this.source.loop=false;return true;}
return false;}});new Class('Main',{Main:function(){main=this;loader.loadClasses(['js/classes/Checkbox.js','js/classes/Ball.js','js/classes/Obstacle.js','js/classes/Hedgehog.js','js/classes/Controller.js','js/classes/LevelController.js','js/classes/LevelParser.js','js/classes/MenuButton.js','js/classes/LevelEditor.js','js/classes/LevelSelector.js','js/classes/LevelSelectorIcon.js','js/classes/LevelCompletionScreen.js','js/classes/Tutorial.js',]);engine.loadFiles(['js/data/objectTypes.js','js/data/tutorials.js',]);engine.currentRoom.addLoop('onRunning',new Engine.CustomLoop(1,function(){return!main.paused;}));engine.currentRoom.addLoop('onPaused',new Engine.CustomLoop(1,function(){return main.paused;}));this.paused=false;this.depths=[];engine.currentRoom.addChildren(bgView=new View.Container(),gridView=new View.Container(),objectsView=new View.Container(this.depths[0]=new View.Container(),new View.Container(this.depths[1]=new View.Container(),this.depths[2]=new View.Container(),this.depths[3]=new View.Container(),this.depths[4]=new View.Container())),overlayView=new View.Container(new View.Container(),new View.Container(this.powerBarBg=new View.Sprite('UI.PowerBar2',397,5,0,{offset:OFFSET_TOP_RIGHT,opacity:0}),this.powerBar=new View.Line(new Math.Vector(366,18),new Math.Vector(366,18),'#FFF',5,'round'),this.powerBarSilver=new View.Line(new Math.Vector(366,18),new Math.Vector(366,18),'#d4d4d4',5,'round'),this.powerBarGold=new View.Line(new Math.Vector(366,18),new Math.Vector(366,18),'#ffed36',5,'round'),this.timerBarBg=new View.Sprite('UI.TimerBar2',403,5,0,{offset:OFFSET_TOP_LEFT,opacity:0}),this.timerBarSilver=new View.Line(new Math.Vector(433,18),new Math.Vector(433,18),'#d4d4d4',5,'round'),this.timerBarGold=new View.Line(new Math.Vector(433,18),new Math.Vector(433,18),'#ffed36',5,'round'),this.backButton=new MenuButton({bitmap:"UI.ArrowPrev",mask:"UI.ArrowPrev",vars:{offset:new Math.Vector(),x:7,y:7},onClick:function(){},}),this.restartButton=new MenuButton({bitmap:"UI.ArrowRestart",mask:"UI.ArrowRestart",onClick:function(){},vars:{offset:new Math.Vector(),x:758,y:6}}),tutorialView=new View.Container(),this.fadeOver=new View.Sprite('UI.LoadScreen',400,200))));this.fadeOver.opacity=0;this.powerBar.opacity=0;this.powerBarSilver.opacity=0;this.powerBarGold.opacity=0;this.timerBarSilver.opacity=0;this.timerBarGold.opacity=0;this.backButton.disable();this.backButton.opacity=0;this.restartButton.disable();this.restartButton.opacity=0;this.levelController=new LevelController();this.gravity=400;this.ballAccelleration=1000;if(localStorage.pullball){this.storage=JSON.parse(localStorage.pullball);}
else{this.storage={levelStats:{},selectedFolder:0,selectedLevel:0};this.saveLocalStorage();}
this.levelController.openLevel('menu.js');loader.hideOverlay(function(){});},getLocalStorage:function(){return this.storage;},saveLocalStorage:function(){localStorage.pullball=JSON.stringify(this.storage);},updateParallax:function(){var view=engine.cameras[0].captureRegion;overlayView.children[1].x=view.x;main.levelController.bg.x=view.x-Math.min(main.levelController.bg.width-engine.canvasResX,view.x/4);main.levelController.mg.x=view.x-view.x/16;main.levelController.fg.x=view.x-Math.min(main.levelController.fg.width-engine.canvasResX,view.x/2);}});new Class('Checkbox',[View.Container],{Checkbox:function(boxSource,checkerSource,x,y,onClick,checked,hideBoxWhenChecked){this.Container();this.box=new Sprite(boxSource,x,y);this.checker=new Sprite(checkerSource,x,y,0,{opacity:0});this.onClick=onClick!==undefined?onClick:function(){};this.addChildren(this.box,this.checker);this.hideBoxWhenChecked=hideBoxWhenChecked
checked=checked!==undefined?checked:false;this.setChecked(checked,0);engine.loops.onRunning.attachFunction(this,this.checkMouse);},setChecked:function(checked,animDuration){animDuration=animDuration!==undefined?animDuration:200;if(checked===undefined){this.checked=!this.checked;}
else if(this.checked===checked){return;}
else{this.checked=checked;}
if(this.hideBoxWhenChecked){this.box.animate({opacity:(this.checked?0:1)},{duration:animDuration})}
this.checker.animate({opacity:(this.checked?1:0)},{duration:animDuration});},checkMouse:function(){if(pointer.shapeIsReleased(MOUSE_TOUCH_ANY,new Rectangle(this.box.x-this.box.offset.x,this.box.y-this.box.offset.y,this.box.width,this.box.height))){if(this.onClick(!this.checked)!==false){this.setChecked();}}},});new Class('Ball',[View.Collidable],{Ball:function(type){this.Collidable('Objects.BallBang',type.vars.x,type.vars.y);this.animationSpeed=0;this.speed=new Math.Vector(0,0);this.size=0;this.power=200;this.powerMax=200;this.powerDrain=60;this.deathTimerStarted=false;this.instructions=type;this.dead=false;this.collisionResolution=4;},spawn:function(callback){this.opacity=1;this.size=0;this.direction=-Math.PI;this.imageNumber=0;this.animationSpeed=0;this.animate({size:1,direction:0},{duration:400,callback:function(){var i;for(i=0;i<main.levelController.controllers.length;i++){main.levelController.controllers[i].assign(this);}
engine.currentRoom.loops.onRunning.attachFunction(this,this.doMovement);callback();}});},startDeathTimer:function(){if(this.deathTimerStarted){return;}
this.deathTimerStarted=true;this.deathTimerText=new View.TextBlock('3',400,200,100,{offset:new Math.Vector(50,70),font:'normal 100px sans-serif',color:'#F33',alignment:'center',opacity:0});this.deathTimerText.animate({opacity:1},{duration:200})
engine.currentRoom.loops.onRunning.schedule(this,function(){if(this.deathTimerStarted){this.deathTimerText.string=2;}},1200);engine.currentRoom.loops.onRunning.schedule(this,function(){if(this.deathTimerStarted){this.deathTimerText.string=1;}},2200);engine.currentRoom.loops.onRunning.schedule(this,function(){if(this.deathTimerStarted){this.die();this.deathTimerText.string=0;this.deathTimerText.animate({opacity:0},{duration:200,callback:function(){engine.purge(this);}});}},3200);tutorialView.addChildren(this.deathTimerText);},stopDeathTimer:function(){this.deathTimerStarted=false;engine.currentRoom.loops.onRunning.unscheduleByCaller(this);this.deathTimerText.animate({opacity:0},{duration:200,callback:function(){engine.purge(this);}});},die:function(){this.stopAnimations();this.dead=true;this.animationSpeed=30;this.animationLoops=false;this.animate({direction:Math.PI/2},{duration:230,easing:'quadOut',callback:function(){this.opacity=0;main.levelController.resetLevel();}});engine.currentRoom.loops.onRunning.detachFunction(this,this.doMovement);},win:function(){main.levelController.timeSpend=engine.currentRoom.loops.onRunning.time-main.levelController.startTime;this.animate({size:0,direction:Math.PI},{duration:400,easing:'quadIn',callback:function(){main.levelController.onLevelComplete();}});engine.currentRoom.loops.onRunning.detachFunction(this,this.doMovement);},updatePower:function(){main.powerBar.b.x=main.powerBar.a.x-(this.power/this.powerMax*297);main.powerBarSilver.b.x=main.powerBar.a.x-(Math.max(0,Math.min(main.levelController.currentLevel.silverPower-main.levelController.powerSpend,this.power))/this.powerMax*297);main.powerBarGold.b.x=main.powerBar.a.x-(Math.max(0,Math.min(main.levelController.currentLevel.goldPower-main.levelController.powerSpend,this.power))/this.powerMax*297);},updateTimer:function(){var timeSpend;timeSpend=engine.currentRoom.loops.onRunning.time-main.levelController.startTime;main.timerBarSilver.b.x=main.timerBarSilver.a.x+(Math.max(0,main.levelController.currentLevel.silverTime-timeSpend)/main.levelController.currentLevel.silverTime*297);main.timerBarGold.b.x=main.timerBarSilver.a.x+(Math.max(0,main.levelController.currentLevel.goldTime-timeSpend)/main.levelController.currentLevel.silverTime*297);},doMovement:function(){var level,p,col,pos,collided,newDir,tries,oldPos,view,oldX,i;level=main.levelController.currentLevel;oldPos=new Math.Vector(this.x,this.y);if(main.levelController.currentLevel.goldTime){this.updateTimer();}
p=pointer.isDown(MOUSE_TOUCH_ANY);if(p&&this.power>0){this.speed.add(new Math.Vector().setFromDirection(new Math.Vector(this.x,this.y).getDirectionTo(p[0]),engine.convertSpeed(main.ballAccelleration)));if(level.power!==false){this.power=Math.max(0,Math.min(this.powerMax,this.power-engine.convertSpeed(this.powerDrain)));this.updatePower();}
main.levelController.powerSpend+=engine.convertSpeed(this.powerDrain);if(main.indicator===undefined||main.indicator.inactive){main.indicator=new View.Circle(0,0,60,'#FFF','#FFF',0);main.indicator.opacity=0;overlayView.children[0].addChildren(main.indicator);}
main.indicator.x=p[0].x-main.indicator.parent.x;main.indicator.y=p[0].y-main.indicator.parent.y;main.indicator.radius=Math.max(40,main.indicator.radius-engine.convertSpeed(100));main.indicator.opacity=Math.min(0.8,main.indicator.opacity+engine.convertSpeed(4));}
else if(main.indicator&&!main.indicator.inactive){main.indicator.inactive=true;main.indicator.animate({radius:0,opacity:0},{duration:500,callback:function(){engine.purge(this);}});}
tries=0;this.x+=engine.convertSpeed(this.speed.x);this.y+=engine.convertSpeed(this.speed.y);if(this.collidesWith(main.levelController.destinations)){this.win();return;}
if(this.collidesWith(main.levelController.deadlies)){this.die();return;}
while(col=this.collidesWith(main.levelController.obstacles,true,false)){if(col===false||tries>10){break;}
tries++;pos=col.combinedPosition;pos.direction=Math.round(pos.getDirection()/Math.PI*8)*Math.PI/8;if(this.speed.getLength()!==0){newDir=pos.direction-((this.speed.getDirection()-Math.PI)-pos.direction);this.speed.setFromDirection(newDir,this.speed.getLength()*0.7);}
if(Math.abs(this.speed.y)<30){this.speed.y=0;}
if(Math.abs(this.speed.x)<6){this.speed.x=0;}
if(this.power===0&&this.speed.x===0&&Math.abs(this.speed.y)<10){this.startDeathTimer();}
else if(this.deathTimerStarted){this.stopDeathTimer();}
this.moveTo(oldPos.x,oldPos.y);this.x+=engine.convertSpeed(this.speed.x);this.y+=engine.convertSpeed(this.speed.y);}
if(level.ceiling&&this.y<16){this.speed.y=-this.speed.y*0.8;this.y=16;}
if(level.wallLeft&&this.x<16){this.speed.x=-this.speed.x*0.8;this.x=16;}else if(level.wallRight&&this.x>level.width-16){this.speed.x=-this.speed.x*0.8;this.x=level.width-16;}
if(this.y>470){this.die();}
this.speed.y+=engine.convertSpeed(main.gravity);view=engine.cameras[0].captureRegion;oldX=view.x;view.x=Math.min(level.width-800,Math.max(0,view.x+(this.x-400-view.x)/10));if(p){p[0].x+=view.x-oldX;}
main.updateParallax();},});new Class('Obstacle',[View.Collidable],{Obstacle:function(type){if(!type.bitmap){this.hidden=true;}
this.Collidable(type.bitmap||type.mask,undefined,undefined,0,{mask:loader.getMask(type.mask,this.getTheme())});this.offset=type.offset?type.offset:this.offset;if(type.vars){this.importProperties(type.vars,true);}
this.instructions=type;switch(type.bitmap){case'Objects.Grass':this.borderLeftOffset=0;this.borderRightOffset=0;this.borders={};this.createBorders();break;case'Objects.GrassUpHill':this.borderLeftOffset=0;this.borderRightOffset=-64;this.borders={};this.createBorders();break;case'Objects.GrassDownHill':this.borderLeftOffset=-64;this.borderRightOffset=0;this.borders={};this.createBorders();break;}},createBorders:function(){var i,children,child;this.borders.left&&engine.purge(this.borders.left);this.borders.right&&engine.purge(this.borders.right);this.borders={left:true,right:true};children=main.depths[this.instructions.depth].children;for(i=0;i<children.length;i++){child=children[i];if(child!==this&&/(Grass|GrassUpHill|GrassDownHill)$/.test(child.source)&&Math.abs(this.x-child.x)===64){if(this.x-child.x>0&&child.y+child.borderRightOffset===this.y+this.borderLeftOffset){engine.purge(child.borders.right);child.borders.right=false;this.borders.left=false;}
if(this.x-child.x<0&&child.y+child.borderLeftOffset===this.y+this.borderRightOffset){engine.purge(child.borders.left);child.borders.left=false;this.borders.right=false;}}}
if(this.borders.left){this.borders.left=new View.Sprite('Objects.GrassEndLeft',-32,this.borderLeftOffset);this.borders.left.importProperties({offset:new Math.Vector(6,7),});this.addChildren(this.borders.left);}
if(this.borders.right){this.borders.right=new View.Sprite('Objects.GrassEndRight',32,this.borderRightOffset);this.borders.right.importProperties({offset:new Math.Vector(0,7),});this.addChildren(this.borders.right);}}});new Class('Hedgehog',[Obstacle],{Hedgehog:function(type){this.Obstacle(type);this.animationSpeed=0;if(this.source==='Objects.HedgehogHanging'&&this.offset.y===34){this.rope=new View.Line(new Math.Vector(this.x,0),new Math.Vector(this.x,this.y),"#8e4b2a",1.5);objectsView.children[type.depth].addChildren(this.rope);this.adjustRopeLength();}
else if(this.source==='Objects.HedgehogHanging'&&this.offset.y===-105){this.rope=new View.Line(new Math.Vector(this.x,this.y),new Math.Vector(this.x,this.y),"#8e4b2a",1.5);this.pole=new View.Sprite('Objects.HedgehogRopePole',this.x,this.y);objectsView.children[type.depth].addChildren(this.rope,this.pole);this.swingTime=2000;this.swingWidth=Math.PI/4;this.targetDir=-this.swingWidth;this.rope.b=this.rope.a.copy().add(new Math.Vector(0,115).rotate(this.targetDir));this.direction=-this.swingWidth;}},onLevelStart:function(){var i;engine.currentRoom.loops.onRunning.attachFunction(this,this.doMovement);if(this.source==='Objects.HedgehogHanging'&&this.offset.y===34){engine.currentRoom.loops.onRunning.attachFunction(this,this.adjustRopeLength);}
if(this.source==='Objects.HedgehogHanging'&&this.offset.y===-105){this.startTime=engine.currentRoom.loops.onRunning.time;engine.currentRoom.loops.onRunning.attachFunction(this,this.swing);}
this.animationSpeed=30;this.speed=new Math.Vector(this.instructions.initSpeedX,this.instructions.initSpeedY);for(i=0;i<main.levelController.controllers.length;i++){main.levelController.controllers[i].assign(this);}},doMovement:function(){var controller;this.x+=engine.convertSpeed(this.speed.x);this.y+=engine.convertSpeed(this.speed.y);},adjustRopeLength:function(){this.rope.b.y=this.y;},swing:function(){var curDir;curDir=Math.sin((engine.currentRoom.loops.onRunning.time-this.startTime)/this.swingTime*Math.PI*2-Math.PI/2)*this.swingWidth;this.direction=curDir;this.rope.b=this.rope.a.copy().add(new Math.Vector(0,115).rotate(this.direction));},});new Class('Controller',[Obstacle],{Controller:function(type){this.Obstacle(type);this.canControl=type.canControl;this.doControl=type.doControl;this.controlledObjects=[];engine.currentRoom.loops.onRunning.attachFunction(this,this.checkCollisions);switch(type.bitmap){case'Objects.TeleIn':case'Objects.TeleOut':engine.currentRoom.loops.onRunning.schedule(this,this.fadeRotate,Math.random()*2000);break;case'Powerups.Power':engine.currentRoom.loops.onRunning.attachFunction(this,this.hover);if(!this.power){this.power=120;this.powerMax=120;}
this.startY=this.y;this.startPeriod=Math.random()*Math.PI*2;this.hover();break;}},assign:function(object){if(this.canControl(object)){this.controlledObjects.push(object);}},checkCollisions:function(){var col,i;if(col=this.collidesWith(this.controlledObjects,false,true)){for(i=0;i<col.objects.length;i++){this.doControl(col.objects[i]);}}},fadeRotate:function(){this.animate({widthScale:1.1,opacity:0.9},{duration:500,callback:function(){this.animate({widthScale:1,opacity:1},{duration:500});}})
this.animate({direction:this.direction+Math.PI/2},{duration:2000,easing:'linear',callback:function(){this.fadeRotate();}})},hover:function(){this.y=this.startY+2.5*Math.sin((this.startPeriod-engine.currentRoom.loops.onRunning.time)/2000*Math.PI*2);},});new Class('LevelController',{LevelController:function(){this.levelQueue=[];this.levelLoaded=false;this.tries=0;this.startTime=0;this.powerSpend=0;engine.ajaxRequest('getLevels.php','',false,function(data){this.levelList=JSON.parse(data);},this);this.ceiling=new View.Sprite('UI.Ceiling',0,0,0,{offset:new Math.Vector(0,0),opacity:0});this.ceiling.width=800;this.wallLeft=new View.Sprite('UI.Ceiling',0,400,-Math.PI/2,{offset:new Math.Vector(),opacity:0});this.wallLeft.width=400;this.wallRight=new View.Sprite('UI.Ceiling',800,0,Math.PI/2,{offset:new Math.Vector(),opacity:0});this.wallRight.width=400;overlayView.children[1].insertBelow(this.ceiling,main.fadeOver);overlayView.children[0].addChildren(this.wallLeft,this.wallRight);this.bg=new View.Sprite('Background1Light',0,0,0,{offset:new Math.Vector(0,0)});this.mg=new View.Container();this.fg=new View.Sprite('Foreground1Light',0,0,0,{offset:new Math.Vector(0,0),opacity:0.7});bgView.addChildren(this.bg,this.mg,this.fg);},onLevelComplete:function(){if(!this.currentLevel.isTesting){this.completionScreen=new LevelCompletionScreen(function(){main.levelController.closeLevel(function(){var levels=this.levelList[this.currentLevelEntry.fId].levels;if(this.currentLevelEntry.lId+1===levels.length){main.storage.selectedFolder=this.currentLevelEntry.fId;main.storage.selectedLevel=this.currentLevelEntry.lId;main.saveLocalStorage();this.openLevel('levels.js');}
else{this.openEntry(levels[this.currentLevelEntry.lId+1]);}});});overlayView.children[1].addChildren(this.completionScreen);this.completionScreen.checkSaveStats();}
else{this.openLevel('editor.js',undefined,function(){main.levelEditor.btnSaveLevel.enable();main.levelEditor.btnSaveLevel.opacity=1;});}},getCurrentLevelStats:function(){index=this.levelList[this.currentLevelEntry.fId].folderName+'/'+this.currentLevelEntry.fileName;if(!main.storage.levelStats.hasOwnProperty(index)){main.storage.levelStats[index]={completed:false,tries:0,bestTime:0,powerAward:0,timeAward:0};main.saveLocalStorage();}
return main.storage.levelStats[index];},closeLevel:function(callback){var objects;objects=[].concat(main.depths[0].children,main.depths[1].children,main.depths[2].children,main.depths[3].children,main.depths[4].children,tutorialView.children);engine.currentRoom.loops.onRunning.unscheduleAll();main.fadeOver.animate({opacity:1},{duration:500,callback:function(){objects.forEach(function(){engine.purge(this);});}});if(main.indicator&&!main.indicator.inactive){main.indicator.inactive=true;main.indicator.animate({radius:0,opacity:0},{duration:500,callback:function(){engine.purge(this);}});}
engine.currentRoom.loops.onRunning.schedule(this,function(){this.levelLoaded=false;callback.call(this);},800);},resetLevel:function(){this.openLevel(this.currentLevel,this.currentLevelEntry);},openEntry:function(entry){this.openLevel('levels/'+this.levelList[entry.fId].folderName+'/'+entry.fileName,entry);},openLevel:function(level,levelEntry,onLevelOpened){if(typeof level==='string'){level=LevelParser.prototype.parseLevel(level);}
if(this.levelLoaded){this.closeLevel(function(){main.levelController.openLevel(level,levelEntry,onLevelOpened);});return;}
this.onLevelOpened=onLevelOpened||function(){};var i,obj,objects,cloud,y;if(level===this.currentLevel){this.tries++;}
else{this.tries=0;}
this.obstacles=[];this.deadlies=[];this.destinations=[];this.controllers=[];this.bg.setSource(level.backgroundImage?level.backgroundImage:'Background1Light');this.fg.setSource(level.foregroundImage?level.foregroundImage:'Foreground1Light');this.mg.removeAllChildren();if(level.clouds){for(i=0+Math.random()*200;i<(level.width-800)/16+800;i+=100+Math.random()*150){y=50+Math.random()*100;cloud=new View.GameObject(level.clouds[Math.floor(Math.random()*level.clouds.length)],i,y,0,{size:1-(150-y)/200,heightScale:1-Math.random()*0.2,speed:new Math.Vector(7+Math.random()*3,0)});cloud.loop.attachFunction(cloud,function(){if(this.x>(main.levelController.currentLevel.width-800)/16+800+this.width/2){this.x=-this.width/2;}});cloud.opacity=level.cloudOpacity?level.cloudOpacity:1;this.mg.addChildren(cloud);}}
main.fadeOver.animate({opacity:0},{duration:500});this.currentLevel=level;this.currentLevelEntry=levelEntry||false;main.backButton.disable();main.backButton.opacity=0;main.backButton.loop=engine.currentRoom.loops.onRunning;main.restartButton.disable();main.restartButton.opacity=0;main.restartButton.loop=engine.currentRoom.loops.onRunning;if(level.isMenu){switch(level.file){case'levels.js':main.backButton.enable();main.backButton.opacity=1;main.backButton.onClick=function(){main.storage.selectedFolder=main.levelSelector.currentFolder;main.storage.selectedLevel=main.levelSelector.currentLevel;main.saveLocalStorage();delete main.levelSelector;main.levelController.openLevel('menu.js');};break;case'editor.js':main.backButton.loop=engine.currentRoom.loops.eachFrame;main.backButton.enable();main.backButton.opacity=1;main.backButton.onClick=function(){main.paused=false;main.levelController.openLevel('menu.js',undefined,function(){main.levelEditor.remove();delete main.levelEditor;});};break;}}
else if(level.isTesting){main.backButton.enable();main.backButton.opacity=1;main.backButton.onClick=function(){main.levelController.openLevel('editor.js');};main.restartButton.enable();main.restartButton.opacity=1;main.restartButton.onClick=function(){main.levelController.resetLevel();};}
else{main.backButton.enable();main.backButton.opacity=1;main.backButton.onClick=function(){main.levelController.openLevel('levels.js');};main.restartButton.enable();main.restartButton.opacity=1;main.restartButton.onClick=function(){main.levelController.resetLevel();};main.storage.selectedFolder=this.currentLevelEntry.fId;main.storage.selectedLevel=this.currentLevelEntry.lId;main.saveLocalStorage();}
this.wallRight.x=level.width;this.ceiling.opacity=level.ceiling?1:0;this.wallLeft.opacity=level.wallLeft?1:0;this.wallRight.opacity=level.wallRight?1:0;delete this.ball;for(i=0;i<level.objects.length;i++){obj=level.objects[i];instance=new window[obj.class](obj);instance.opacity=obj.opacity!==undefined?obj.opacity:1;if(obj.group){this[obj.group].push(instance);}
else if(obj.class==='Ball'){this.ball=instance;this.ball.power=level.power||200;}
main.depths[obj.depth||0].addChildren(instance);}
if(level.power!==false){this.powerSpend=0;main.powerBarBg.opacity=1;main.powerBar.opacity=1;main.powerBarSilver.opacity=1;main.powerBarGold.opacity=1;this.ball.updatePower(false);}
else{main.powerBarBg.opacity=0;main.powerBar.opacity=0;main.powerBarSilver.opacity=0;main.powerBarGold.opacity=0;}
if(level.goldTime&&level.silverTime){main.levelController.startTime=engine.currentRoom.loops.onRunning.time;main.timerBarBg.opacity=1;main.timerBarSilver.opacity=1;main.timerBarGold.opacity=1;this.ball.updateTimer(false);}
else{main.timerBarBg.opacity=0;main.timerBarSilver.opacity=0;main.timerBarGold.opacity=0;}
this.levelLoaded=true;this.onLevelOpened();this.startLevel();},startLevel:function(){var x,time,stats;if(this.tries>0||this.currentLevel.isMenu){engine.cameras[0].captureRegion.x=0;overlayView.children[1].x=0;this.bg.x=0;this.mg.x=0;this.fg.x=0;time=0;}
else{x=this.currentLevel.width-engine.canvasResX;time=500+(x*1.5);engine.cameras[0].captureRegion.x=x;main.updateParallax();engine.currentRoom.loops.onRunning.schedule(this,function(){engine.cameras[0].captureRegion.animate({x:0},{duration:time,onStep:main.updateParallax});},1000);}
if(!this.currentLevel.isMenu&&!this.currentLevel.isTesting){stats=this.getCurrentLevelStats();if(!stats.completed){stats.tries++;main.saveLocalStorage();}}
engine.currentRoom.loops.onRunning.schedule(this,function(){this.ball.spawn(function(){main.levelController.deadlies.forEach(function(){if(this.onLevelStart){this.onLevelStart();}});main.levelController.startTime=engine.currentRoom.loops.onRunning.time;main.levelController.powerSpend=0;if(main.levelController.currentLevel.tutorial&&main.levelController.tries===0){tutorialView.addChildren(new Tutorial(tutorials[main.levelController.currentLevel.tutorial]));}});},1000+time);},});new Class('LevelParser',{parseLevel:function(url){var type,level;type=url.match(/([^\.]*)$/)[1];engine.ajaxRequest(url,undefined,false,function(data){data+="\n//# sourceURL=/"+url;switch(type){case'lvl':level=LevelParser.prototype.parseLvl(data);level.file=url;break;case'js':level=LevelParser.prototype.parseJs(data);level.file=url;break;}});return level;},parseJs:function(data){var level;try{eval('level = '+data);}
catch(e){throw new Error(e);}
return level;},parseLvl:function(data){var offsets,i,variables,lines,line,level,obj,variable;function parseObject(line){var lineData,object;lineData=line.split(/\s+/);object={vars:{}};switch(lineData[0]){case'master_grass':case'0':level.theme='GrassLands';return;case'obj_bold':case'1':object.importProperties(objectTypes.Ball);break;case'obj_graes':case'3':object.importProperties(objectTypes.Grass);break;case'obj_busk':case'5':object.importProperties(objectTypes.Bush);break;case'obj_maal':case'6':object.importProperties(objectTypes.Destination);break;case'obj_kraft':case'7':object.importProperties(objectTypes.Power);object.vars.power=120;object.vars.powerMax=120;break;case'obj_lian':case'8':object.importProperties(objectTypes.Lian);break;case'obj_pigge':case'9':object.importProperties(objectTypes.Spikes);break;case'obj_pindsvin':case'10':object.importProperties(objectTypes.Hedgehog);break;case'obj_turn':case'11':object.importProperties(objectTypes.TurnHV);break;case'obj_trampolin':case'16':object.importProperties(objectTypes.Trampoline);break;case'obj_tele_ind':case'20':object.importProperties(objectTypes.Teleport);object.vars.name='teleIn';object.vars.destination='teleOut';break;case'obj_tele_ud':case'21':object.importProperties(objectTypes.Teleport);object.bitmap='Objects.TeleOut';object.vars.name='teleOut';break;case'obj_pindsvin_v':case'27':object.importProperties(objectTypes.HedgehogClimbing);break;case'obj_pindsvin_pendul':case'28':object.importProperties(objectTypes.HedgehogSwinging);break;case'obj_graes_skraa_v':object.importProperties(objectTypes.GrassDownHill);break;case'obj_graes_skraa_h':object.importProperties(objectTypes.GrassUpHill);break;default:;return;}
object.vars.importProperties({offset:new Math.Vector(object.offsetLvlX,object.offsetLvlY),x:lineData[1]*1,y:lineData[2]*1});level.objects.push(object);}
function parseVariable(line){var lineData;lineData=line.split(": ");switch(lineData[0]){case'width':level.width=lineData[1]*1;break;case'goldPower':level.goldPower=lineData[1]*1;break;case'silverPower':level.silverPower=lineData[1]*1;break;case'goldTime':level.goldTime=lineData[1]*1;break;case'silverTime':level.silverTime=lineData[1]*1;break;case'loft':level.ceiling=lineData[1]*1?true:false;break;case'kraft':level.power=lineData[1]*1;if(level.power===0){level.power=false;}
break;case'wallLeft':level.wallLeft=(lineData[1]*1==true);break;case'wallRight':level.wallRight=(lineData[1]*1==true);break;case'background':level.backgroundImage=lineData[1];break;case'foreground':level.foregroundImage=lineData[1];break;case'tutorial':level.tutorial=lineData[1];break;}}
level={objects:[],theme:"GrassLands",ceiling:true,};lines=data.split(/\r\n|\r|\n/);for(i=0;i<lines.length;i++){line=lines[i];if(line===' - variables - '){variables=true;continue;}
if(!variables){parseObject(line);}
else{parseVariable(line);}}
if(level.theme==="GrassLands"){level.clouds=['Objects.Cloud'];if(/Dark$/.test(level.backgroundImage)){level.cloudOpacity=0.7;}}
return level;},});new Class('MenuButton',[View.Collidable],{MenuButton:function(type){this.Collidable(type.bitmap||type.mask,undefined,undefined,0,{mask:loader.getMask(type.mask||type.bitmap,this.getTheme())});this.animationDuration=1;if(type.vars){this.importProperties(type.vars,true);}
this.onClick=type.onClick;this.loop=type.loop||engine.currentRoom.loops.onRunning;if(this.onClick){this.clickBox=new Math.Rectangle(-this.offset.x,-this.offset.y,this.width,this.height);this.enable();}
this.instructions=type;this.down=false;this.startOffset=this.offset.y;this.onLoaded&&this.onLoaded();},checkClick:function(){var box;box=this.clickBox.copy().add(this.getRoomPosition());if(pointer.shapeIsPressed(MOUSE_TOUCH_ANY,box)){this.down=true;this.animate({opacity:0.8},{duration:this.animationDuration});this.offset.animate({y:this.startOffset-2},{duration:this.animationDuration});}
if(pointer.shapeIsReleased(MOUSE_TOUCH_ANY,box)){if(this.down){this.down=false;this.animate({opacity:1},{duration:this.animationDuration});this.offset.animate({y:this.startOffset},{duration:this.animationDuration});this.onClick();}}else if(pointer.isReleased(MOUSE_TOUCH_ANY)){this.down=false;this.animate({opacity:1},{duration:this.animationDuration});this.offset.animate({y:this.startOffset},{duration:this.animationDuration});}},disable:function(){this.loop.detachFunction(this,this.checkClick);},enable:function(){this.loop.detachFunction(this,this.checkClick);this.loop.attachFunction(this,this.checkClick);}});new Class('LevelEditor',[View.Container],{LevelEditor:function(type){var obj;main.levelEditor=this;this.Container();this.targetPos=0;this.moving=false;this.scrolling=false;this.ball=false;this.selectedObject=false;this.selectedObjectStartTime=false;this.currentPortal=1;this.portals=[false,false];this.placedObjects=[];this.placeMode=true;this.initGrid();this.currentObjectType=objectTypes.Grass
this.cursor=new View.Sprite(this.currentObjectType.bitmap,0,0,0,{offset:new Math.Vector(this.currentObjectType.offsetX,this.currentObjectType.offsetY),opacity:0.6});overlayView.children[0].addChildren(this.cursor);this.numbArea=new Math.Rectangle(0,0,585,42);this.initTopMenu();this.initLevel();engine.currentRoom.loops.eachFrame.attachFunction(this,this.doControls);document.addEventListener('mousewheel',this.doObjectSelection);main.paused=true;},initLevel:function(){if(localStorage&&localStorage.pullballEditorLevel){this.loadLevelFromStorage();}
else{this.level={"theme":"GrassLands","ceiling":true,"width":800,"power":false,"backgroundImage":'Background2Light',"clouds":['Objects.Cloud'],"wallLeft":true,"wallRight":true,"isCompletable":false,};}},initGrid:function(){var i,line;this.gridX=[];this.gridY=[];for(i=8;i<=800;i+=16){line=new View.Line(new Math.Vector(),new Math.Vector(0,400),'#FFF',0.5);line.x=i;this.gridX.push(line);}
for(i=8;i<=400;i+=16){line=new View.Line(new Math.Vector(),new Math.Vector(800,0),'#FFF',0.5);line.y=i;this.gridY.push(line);}
gridView.addChildren.apply(gridView,[].concat(this.gridX,this.gridY));},initTopMenu:function(){this.topMenu=new View.Sprite('Editor.TopMenu',0,0,0,{offset:new Math.Vector(-72,2)});this.btnHide=new MenuButton({"bitmap":"UI.ArrowUp","vars":{"x":68,"y":24,},"loop":engine.currentRoom.loops.eachFrame,"onClick":function(){if(!main.levelEditor.topMenu.hidden){main.levelEditor.topMenu.animate({y:-50},{duration:200});main.levelEditor.topMenu.hidden=true;main.levelEditor.numbArea.width=85;this.animate({direction:-Math.PI},{duration:200});}
else{main.levelEditor.topMenu.animate({y:0},{duration:200});main.levelEditor.topMenu.hidden=false;main.levelEditor.numbArea.width=585;this.animate({direction:0},{duration:200});}}});this.topMenu.hidden=false;overlayView.children[1].insertBelow([this.topMenu,this.btnHide],main.fadeOver);this.topMenu.addChildren(new MenuButton({"bitmap":"Editor.PrevObject","vars":{"offset":new Math.Vector(),"x":102,"y":17},"loop":engine.currentRoom.loops.eachFrame,"onClick":function(){main.levelEditor.doObjectSelection({wheelDelta:-1});}}),this.topMenu.preview=new View.Sprite(this.currentObjectType.bitmap,150,24),new MenuButton({"bitmap":"Editor.NextObject","vars":{"offset":new Math.Vector(),"x":184,"y":17},"loop":engine.currentRoom.loops.eachFrame,"onClick":function(){main.levelEditor.doObjectSelection({wheelDelta:1});}}),this.btnClearLevel=new MenuButton({"bitmap":"Editor.ClearLevel","vars":{"offset":new Math.Vector(),"x":215,"y":7},"loop":engine.currentRoom.loops.eachFrame,"onClick":function(){if(confirm('Are you sure you want to remove all objects from the level?')){main.levelEditor.clearLevel();}}}),new MenuButton({"bitmap":"Editor.ToggleWalls","vars":{"offset":new Math.Vector(),"x":265,"y":7},"loop":engine.currentRoom.loops.eachFrame,"onClick":function(){main.levelEditor.toggleWalls();}}),new MenuButton({"bitmap":"Editor.ToggleCeiling","vars":{"offset":new Math.Vector(),"x":314,"y":7},"loop":engine.currentRoom.loops.eachFrame,"onClick":function(){main.levelEditor.toggleCeiling();}}),new MenuButton({"bitmap":"Editor.DecreaseWidth","vars":{"offset":new Math.Vector(),"x":363,"y":7},"loop":engine.currentRoom.loops.eachFrame,"onClick":function(){main.levelEditor.decreaseLevelWidth();}}),new MenuButton({"bitmap":"Editor.IncreaseWidth","vars":{"offset":new Math.Vector(),"x":413,"y":7},"loop":engine.currentRoom.loops.eachFrame,"onClick":function(){main.levelEditor.increaseLevelWidth();}}),this.btnPowerSelector=new MenuButton({"bitmap":"Editor.PowerSelector","vars":{"offset":new Math.Vector(),"x":464,"y":14,onLoaded:function(){this.powerShadow=new View.Line(new Math.Vector(0,0),new Math.Vector(30,0),'#e75b35',3);this.powerShadow.x=0;this.powerShadow.y=-5;this.powerShadow.opacity=0.4;this.powerLine=new View.Line(new Math.Vector(0,0),new Math.Vector(0,0),'#e75b35',2);this.powerLine.x=1;this.powerLine.y=-5;this.addChildren(this.powerShadow,this.powerLine);this.power=0;},},"loop":engine.currentRoom.loops.eachFrame,onClick:function(){if(this.power<200){this.power+=50}
else{this.power=0;}
this.powerLine.b.animate({x:this.power/200*28},{duration:200});main.levelEditor.level.power=this.power>0?this.power:false;main.levelEditor.onObjectsChanged();}}),this.btnTestLevel=new MenuButton({"bitmap":"Editor.TestLevel","vars":{"offset":new Math.Vector(),"x":508,"y":5},"loop":engine.currentRoom.loops.eachFrame,"onClick":function(){main.levelEditor.testLevel();}}),this.btnSaveLevel=new MenuButton({"bitmap":"Editor.SaveLevel","vars":{"offset":new Math.Vector(),"x":546,"y":6},"loop":engine.currentRoom.loops.eachFrame,"onClick":function(){main.levelEditor.downloadLevel();}}));this.updateObjectPreview();this.onObjectsChanged();},doControls:function(){var p;if(keyboard.isDown(KEY_LEFT)){this.moving||this.moveLeft();}
if(keyboard.isDown(KEY_RIGHT)){this.moving||this.moveRight();}
if(this.placeMode){p=pointer.isPressed(MOUSE_1)
if(p){p=p[0];if(!this.numbArea.copy().move(engine.cameras[0].captureRegion.x,0).contains(p)){this.placeObject(this.currentObjectType,this.cursor.x,this.cursor.y);this.onObjectsChanged();}}
if(pointer.isPressed(MOUSE_3)){if(this.selectedObject){this.removeObject(this.selectedObject);}}
if(!this.numbArea.copy().move(engine.cameras[0].captureRegion.x,0).contains(pointer.mouse)){this.cursor.x=Math.round((pointer.mouse.x+8)/16)*16-8;this.cursor.y=Math.round((pointer.mouse.y+8)/16)*16-8;if(this.cursor.opacity!==0.6&&!this.cursor.isAnimated()){this.cursor.animate({opacity:0.6},{duration:200});}}
else if(this.cursor.opacity!==0&&!this.cursor.isAnimated()){this.cursor.animate({opacity:0},{duration:200});}
this.selectClosestObject();if(this.selectedObject){this.selectedObject.opacity=1+Math.sin((engine.gameTime-this.selectedObjectStartTime)/500*Math.PI)/2;}}},doObjectSelection:function(e){if(this!==main.levelEditor){main.levelEditor.doObjectSelection.call(main.levelEditor,e);return}
if(this.scrolling){return;}
var typeNames,typeName,i;typeNames=Object.keys(objectTypes);for(i=0;i<typeNames.length;i++){typeName=typeNames[i];if(objectTypes[typeName]===this.currentObjectType){if(e.wheelDelta<0){if(i<typeNames.length-1){this.currentObjectType=objectTypes[typeNames[i+1]];}
else{this.currentObjectType=objectTypes[typeNames[0]];}}
else{if(i>0){this.currentObjectType=objectTypes[typeNames[i-1]];}
else{this.currentObjectType=objectTypes[typeNames[typeNames.length-1]];}}
break;}}
this.updateCursorObject();this.updateObjectPreview();this.scrolling=true;this.schedule(function(){this.scrolling=false;},200);},updateObjectPreview:function(){var p,source;p=this.topMenu.preview;if(this.currentObjectType.bitmap=='Objects.TeleIn'){source=this.currentPortal===1?'Objects.TeleIn':'Objects.TeleOut';}
else{source=this.currentObjectType.bitmap}
p.setSource(source);p.offset.x=p.clipWidth/2;p.offset.y=p.clipHeight/2;p.width=50;p.height=50;p.widthScale=Math.min(p.widthScale,p.heightScale,1);p.heightScale=Math.min(p.widthScale,p.heightScale,1);},updateCursorObject:function(){var source;if(this.currentObjectType.bitmap=='Objects.TeleIn'){source=this.currentPortal===1?'Objects.TeleIn':'Objects.TeleOut';}
else{source=this.currentObjectType.bitmap;}
this.cursor.setSource(source);this.cursor.offset.set(this.currentObjectType.offsetX,this.currentObjectType.offsetY);},placeObject:function(objectType,x,y){var type,instance;type={}
type.importProperties(objectType);if(!type.vars){type.vars={x:x,y:y,offset:{x:type.offsetX,y:type.offsetY}};}
if(type.class!=='Ball'){instance=new window[type.class](type);if(/^Objects\.Tele(In|Out)$/.test(type.bitmap)){if(type.vars.name){if(type.vars.name=='teleIn'){this.portals[0]=instance;}
else{this.portals[1]=instance;}}
else{if(this.currentPortal==1){type.vars.name='teleIn';type.vars.destination='teleOut';if(this.portals[0]){this.removeObject(this.portals[0]);}
this.portals[0]=instance;}
else{type.vars.name='teleOut';type.bitmap='Objects.TeleOut';instance.setSource('Objects.TeleOut');if(this.portals[1]){this.removeObject(this.portals[1]);}
this.portals[1]=instance;}}
this.currentPortal=this.currentPortal===1?2:1;this.updateObjectPreview();this.updateCursorObject();}}
else{if(this.ball){this.ball.x=type.vars.x;this.ball.y=type.vars.y;}
else{instance=new window[type.class](type);this.ball=instance;this.ball.direction=0;this.ball.size=1;}}
if(instance!==undefined){main.depths[type.depth||0].addChildren(instance);this.placedObjects.push(instance);}},selectClosestObject:function(){var oldObject,i,object;oldObject=this.selectedObject;oldObject.opacity=1;this.selectedObject=false;for(i=this.placedObjects.length-1;i>=0;i--){object=this.placedObjects[i];if(Math.abs(object.x-this.cursor.x)<20&&Math.abs(object.y-this.cursor.y)<20){this.selectedObject=object;if(this.selectedObject!==oldObject){this.selectedObjectStartTime=engine.gameTime;}
break;}}},removeObject:function(object){var i;this.placedObjects.splice(this.placedObjects.indexOf(object),1);if(object===this.ball){this.ball=false;}
if(/^Objects\.Tele(In|Out)$/.test(object.source)){if(object.source==='Objects.TeleIn'){this.portals[0]=false;}
else{this.portals[1]=false;}
this.currentPortal=this.portals[0]?2:1;this.updateObjectPreview();this.updateCursorObject();}
object.rope&&engine.purge(object.rope);object.pole&&engine.purge(object.pole);engine.purge(object);this.selectClosestObject();for(i=0;i<this.placedObjects.length;i++){object=this.placedObjects[i];if(/(Grass|GrassUpHill|GrassDownHill)$/.test(object.source)){object.createBorders();}}
this.onObjectsChanged();},clearLevel:function(){var i;i=this.placedObjects.length;while(i--){this.removeObject(this.placedObjects[i]);}},onObjectsChanged:function(){this.btnSaveLevel.disable();this.btnSaveLevel.opacity=0.4;if(!this.ball||(!!this.portals[0]+!!this.portals[1])%2!==0){this.btnTestLevel.disable();this.btnTestLevel.opacity=0.4;}
else{this.btnTestLevel.enable();this.btnTestLevel.opacity=1;}
if(!this.placedObjects.length){this.btnClearLevel.disable();this.btnClearLevel.opacity=0.4;}
else{this.btnClearLevel.enable();this.btnClearLevel.opacity=1;}
if(this.level){this.saveLevelToStorage();}},openLevel:function(level){this.clearLevel();if(typeof level==='string'){level=LevelParser.prototype.parseLevel(level);}
this.level=level;level.objects.forEach(function(){main.levelEditor.placeObject(this,this.vars.x,this.vars.y);});this.btnPowerSelector.power=this.level.power?this.level.power:0;this.btnPowerSelector.powerLine.b.x=this.level.power/200*28;this.onObjectsChanged();this.onSettingsChanged();},serializeLevel:function(){var obj,str;this.level.objects=this.createObjectsArray();delete this.level.isTesting;delete this.level.isCompletable;str=JSON.stringify(this.level,function(key,value){return(typeof value==='function')?value.toString():value;},'\t');str=str.replace(/"function/g,"function");str=str.replace(/\}",/g,'},');str=str.replace(/\\n/g,"\n");str=str.replace(/\\t/g,"\t");str=str.replace(/\\\\/g,'');str=str.replace(/\\"/g,'"');this.level.isTesting=true;this.level.isCompletable=true;return str;},downloadLevel:function(name){var dataString,a;name=name||'level.js';dataString='data:data/html,'+encodeURIComponent(this.serializeLevel());a=document.createElement('a');a.href=dataString;a.setAttribute('download',name);document.body.appendChild(a);a.click();document.body.removeChild(a,document.body);},loadLevelFromStorage:function(){this.openLevel(LevelParser.prototype.parseJs(localStorage.pullballEditorLevel));},saveLevelToStorage:function(){localStorage.pullballEditorLevel=this.serializeLevel();},createObjectsArray:function(){var objects,object,i;objects=[];for(i=0;i<this.placedObjects.length;i++){object=this.placedObjects[i];object.instructions.vars.x=object.x;object.instructions.vars.y=object.y;objects.push(object.instructions);}
return objects;},testLevel:function(){var obj;this.level.objects=this.createObjectsArray();this.level.isTesting=true;main.paused=false;obj=this;main.levelController.openLevel(this.level,undefined,function(){obj.remove();});},increaseLevelWidth:function(){this.level.width=Math.min(4000,this.level.width+160);this.onSettingsChanged();},decreaseLevelWidth:function(){this.level.width=Math.max(800,this.level.width-160);this.onSettingsChanged();},toggleWalls:function(){if(this.level.wallRight){this.level.wallLeft=false;this.level.wallRight=false;}
else{this.level.wallLeft=true;this.level.wallRight=true;}
this.onSettingsChanged();},toggleCeiling:function(){this.level.ceiling=!this.level.ceiling;this.onSettingsChanged();},onSettingsChanged:function(){main.levelController.wallLeft.animate({opacity:this.level.wallLeft*1},{duration:200});main.levelController.wallRight.animate({opacity:this.level.wallRight*1},{duration:200});main.levelController.ceiling.animate({opacity:this.level.ceiling*1},{duration:200});if(this.level.width!==main.levelController.currentLevel.width){main.levelController.wallRight.animate({x:this.level.width},{duration:200});main.levelController.currentLevel.width=this.level.width;if(this.targetPos>this.level.width-800){this.targetPos=this.level.width-800;this.moveToPosition();}}
this.saveLevelToStorage();},moveLeft:function(){this.targetPos=Math.max(0,this.targetPos-160);this.moveToPosition();},moveRight:function(){this.targetPos=Math.min(this.level.width-800,this.targetPos+160);this.moveToPosition();},moveToPosition:function(){var obj;this.moving=true;obj=this;engine.cameras[0].captureRegion.animate({x:this.targetPos},{duration:200,onStep:function(){main.updateParallax();obj.updateGrid();},callback:function(){obj.moving=false;}});},updateGrid:function(){var camX;camX=engine.cameras[0].captureRegion.x;this.gridY.forEach(function(){this.a.x=camX;this.b.x=camX+800;});this.gridX.forEach(function(){if(this.x-camX>800){this.x-=800;}
else if(this.x-camX<0){this.x+=800;}});},remove:function(){gridView.removeAllChildren();engine.purge(this.topMenu,this.cursor,this.btnHide);engine.purge(this);document.removeEventListener('mousewheel',this.doObjectSelection);},});new Class('LevelSelector',[View.Container],{LevelSelector:function(type,x,y){this.Container(new View.Container(),new View.Container());main.levelSelector=this;this.currentFolder;this.currentLevel;this.folderSpacing=122;this.folders=[];this.levels=[];this.folderSelectorActive=false;this.levelSelectorActive=false;this.createFolders();this.selectFolder(main.storage.selectedFolder);this.selectLevel(main.storage.selectedLevel);this.children[1].addChildren(new View.Sprite('Menu.LevelHighlight',311,200,0,{opacity:1}),new View.Sprite('Menu.LevelHighlight',526,200,0,{opacity:1}),new MenuButton({"bitmap":"Menu.Play","mask":"Menu.Play","vars":{x:710,y:200},"onClick":function(){var levelSelector;levelSelector=this.parent.parent;main.levelController.openEntry(main.levelController.levelList[levelSelector.currentFolder].levels[levelSelector.currentLevel]);}}));this.children[1].addChildren(new View.Sprite('UI.ArrowNext',419,200,0,{opacity:1}));engine.currentRoom.loops.onRunning.attachFunction(this,this.doFolderSelector);engine.currentRoom.loops.onRunning.attachFunction(this,this.doLevelSelector);},createFolders:function(){var i,folder;for(i=0;i<main.levelController.levelList.length;i++){this.folders.push(new LevelSelectorIcon(main.levelController.levelList[i]));}
for(i=0;i<this.folders.length;i++){folder=this.folders[i];folder.x=310;folder.y=200+this.folderSpacing*i;}
this.children[0].addChildren.apply(this.children[0],this.folders);},createLevels:function(){var i,level;for(i=0;i<this.levels.length;i++){this.levels[i].remove();}
this.levels=[];for(i=0;i<main.levelController.levelList[this.currentFolder].levels.length;i++){level=new LevelSelectorIcon(main.levelController.levelList[this.currentFolder].levels[i]);this.levels.push(level);}
for(i=0;i<this.levels.length;i++){level=this.levels[i];level.x=525;level.y=200+(i-this.currentLevel)*this.folderSpacing;}
this.children[0].addChildren.apply(this.children[0],this.levels);},doFolderSelector:function(){var pointers,x,y,i,folder,dist,goToFolder;if(pointers=pointer.shapeIsPressed(MOUSE_TOUCH_ANY,new Math.Rectangle(220,0,180,400))){this.initY=pointers[0].y;this.initX=pointers[0].x;this.folderSelectorActive=true;this.clicking=true;}
if(this.folderSelectorActive&&(pointers=pointer.isDown(MOUSE_TOUCH_ANY))){x=pointers[0].x;y=pointers[0].y;if(new Math.Vector(x,y).getDistance(new Math.Vector(this.initX,this.initY))>5){this.clicking=false;}
for(i=0;i<this.folders.length;i++){folder=this.folders[i];folder.y=200+(i-this.currentFolder)*this.folderSpacing+(y-this.initY);}}
dist=10000;if(this.folderSelectorActive&&(pointers=pointer.isReleased(MOUSE_TOUCH_ANY))){for(i=0;i<this.folders.length;i++){folder=this.folders[i];if(Math.abs(folder.y-(this.clicking?pointers[0].y:200))<dist){goToFolder=i;dist=Math.abs(folder.y-(this.clicking?pointers[0].y:200));}}
this.folderSelectorActive=false;this.selectFolder(goToFolder);}},doLevelSelector:function(){var pointers,x,y,i,level,dist,goToLevel;if(pointers=pointer.shapeIsPressed(MOUSE_TOUCH_ANY,new Math.Rectangle(435,0,180,400))){this.initY=pointers[0].y;this.initX=pointers[0].x;this.levelSelectorActive=true;this.clicking=true;}
if(this.levelSelectorActive&&(pointers=pointer.isDown(MOUSE_TOUCH_ANY))){x=pointers[0].x;y=pointers[0].y;if(new Math.Vector(x,y).getDistance(new Math.Vector(this.initX,this.initY))>5){this.clicking=false;}
for(i=0;i<this.levels.length;i++){level=this.levels[i];level.y=200+(i-this.currentLevel)*this.folderSpacing+(y-this.initY);}}
dist=10000;if(this.levelSelectorActive&&(pointers=pointer.isReleased(MOUSE_TOUCH_ANY))){for(i=0;i<this.levels.length;i++){level=this.levels[i];if(!level.unlocked){continue;}
if(Math.abs(level.y-(this.clicking?pointers[0].y:200))<dist){goToLevel=i;dist=Math.abs(level.y-(this.clicking?pointers[0].y:200));}}
this.levelSelectorActive=false;this.selectLevel(goToLevel);}},selectFolder:function(fId){if(this.currentFolder===fId){this.moveFoldersIntoPlace();return;}
this.currentFolder=fId;this.moveFoldersIntoPlace();this.currentLevel=0;this.createLevels();this.moveLevelsIntoPlace();},selectLevel:function(lId){this.currentLevel=lId;this.moveLevelsIntoPlace();},moveFoldersIntoPlace:function(){for(i=0;i<this.folders.length;i++){folder=this.folders[i];folder.animate({y:200+(i-this.currentFolder)*this.folderSpacing},{duration:200});}},moveLevelsIntoPlace:function(){for(i=0;i<this.levels.length;i++){level=this.levels[i];level.animate({y:200+(i-this.currentLevel)*this.folderSpacing},{duration:200});}}});new Class('LevelSelectorIcon',[View.Container],{LevelSelectorIcon:function(entry){var caller,hash,folder,i,levelsCompleted,levelsTotal,stats;this.Container();this.entry=entry;folder=this.entry.folderName?this.entry:main.levelController.levelList[this.entry.fId];this.levelsCount=0;this.silverTimeCount=0;this.goldTimeCount=0;this.silverPowerCount=0;this.goldPowerCount=0;this.completedCount=0;this.fullyCompletedCount=0;for(i in main.storage.levelStats){if(main.storage.levelStats.hasOwnProperty(i)){if(new RegExp('^'+folder.folderName+'\\/').test(i)){stats=main.storage.levelStats[i];this.completedCount+=stats.completed*1;this.fullyCompletedCount+=(stats.fullyCompleted?1:0);this.goldPowerCount+=(stats.powerAward===2||stats.fullyCompleted)*1;this.silverPowerCount+=(stats.powerAward>=1||stats.fullyCompleted)*1;this.goldTimeCount+=(stats.timeAward===2||stats.fullyCompleted)*1;this.silverTimeCount+=(stats.timeAward>=1||stats.fullyCompleted)*1;}}}
this.levelsCount=folder.levels.length;if(this.entry.fileName){hash=folder.folderName+'/'+this.entry.fileName;this.stats=main.storage.levelStats[hash];this.unlocked=this.entry.lId<this.completedCount+3||folder.folderName==='10_Custom';}
else{this.stats={completed:this.levelsCount===this.completedCount,powerAward:0,timeAward:0,fullyCompleted:this.levelsCount===this.fullyCompletedCount,}
if(this.levelsCount===this.goldPowerCount){this.stats.powerAward=2;}
else if(this.levelsCount===this.silverPowerCount){this.stats.powerAward=1;}
if(this.levelsCount===this.goldTimeCount){this.stats.timeAward=2;}
else if(this.levelsCount===this.silverTimeCount){this.stats.timeAward=1;}}
if(this.entry.screenShot&&(this.entry.folderName||this.unlocked)){caller=this;if(this.entry.folderName){loader.loadExternalResource('Folder.'+this.entry.fId,'levels/'+this.entry.screenShot,function(){caller.makeThumb('Folder.'+caller.entry.fId);});}
else{loader.loadExternalResource('Level.'+this.entry.fId+'.'+this.entry.lId,'levels/'+folder.folderName+'/'+this.entry.screenShot,function(){caller.makeThumb('Level.'+caller.entry.fId+'.'+caller.entry.lId);});}}
else if(this.entry.folderName||this.unlocked){this.makeThumb('Menu.LevelThumb');}
else{this.makeThumb('Menu.LevelLocked');}},makeThumb:function(thumbNail){var shadow,thumb,text,text2,lock,awards;this.addChildren(shadow=new View.Sprite('Menu.LevelShadow',3,3,0,{opacity:0}),thumb=new View.Sprite(thumbNail,5,0,0,{opacity:0}),text=new View.TextBlock((this.entry.fileName||this.entry.folderName).replace(/^\d*_/,'').replace(/\.(lvl|js)$/,''),5,57,160,{opacity:0,font:"16px Verdana, Arial",color:'#fff',offset:new Math.Vector(82,15)}));if(this.entry.folderName){text2=new View.TextBlock(this.completedCount+'/'+this.levelsCount,5,57,160,{opacity:0,alignment:'right',font:"16px Verdana, Arial",color:'#fff',offset:new Math.Vector(82,15)});this.addChildren(text2);text2.animate({opacity:1},{duration:500});}
else if(!this.unlocked){this.addChildren(lock=new View.Sprite('Menu.Lock',0,0,0,{size:0}));lock.animate({size:1},{duration:500});}
awards=[];if(this.stats){if(this.stats.fullyCompleted){awards.push(new View.Sprite('Menu.StarGold',0,0,0,{size:0}));}
else{if(this.stats.completed){awards.push(new View.Sprite('Menu.StarSilver',0,0,0,{size:0}));}
if(this.stats.powerAward){awards.push(new View.Sprite('Menu.Power'+(this.stats.powerAward===2?'Gold':'Silver'),-50,0,0,{size:0}));}
if(this.stats.timeAward){awards.push(new View.Sprite('Menu.Clock'+(this.stats.timeAward===2?'Gold':'Silver'),50,0,0,{size:0}));}}}
thumb.animate({x:0,opacity:1},{duration:500,callback:function(){shadow.animate({opacity:0.2},{duration:300});if(awards.length){this.addChildren.apply(this,awards);awards.forEach(function(){this.animate({size:1},{duration:300});});}}});text.animate({x:0,opacity:1},{duration:500});},remove:function(){this.children.forEach(function(){this.animate({opacity:0},{duration:400});});this.animate({size:1.1},{duration:400,callback:function(){engine.purge(this);}});}});new Class('LevelCompletionScreen',[View.Container],{LevelCompletionScreen:function(onNext){this.Container();this.x=400;this.justCompleted=false;this.oldPowerAwardLevel=0;this.oldTimeAwardLevel=0;this.oldFullyCompleted=false;this.newTimeAwardLevel=0;this.newPowerAwardLevel=0;this.newFullyCompleted=false;this.completionAward=false;this.powerAward=false;this.timeAward=false;this.awardSpacing=140;this.onNext=onNext;main.backButton.disable();main.backButton.animate({opacity:0.5},{duration:200});main.restartButton.disable();main.restartButton.animate({opacity:0.5},{duration:200});if(main.indicator&&!main.indicator.inactive){main.indicator.inactive=true;main.indicator.animate({radius:0,opacity:0},{duration:500,callback:function(){engine.purge(this);}});}},checkSaveStats:function(){var c,stats,time,newTimeAward,newPowerAward;c=main.levelController;stats=c.getCurrentLevelStats();if(stats.completed){stats.bestTime=stats.bestTime<time?stats.bestTime:c.timeSpend;stats.bestPower=stats.bestPower<c.powerSpend?stats.bestPower:c.powerSpend;}
else{stats.completed=true;this.justCompleted=true;stats.bestTime=c.timeSpend;stats.bestPower=c.powerSpend;};this.oldTimeAwardLevel=stats.timeAward;this.oldPowerAwardLevel=stats.powerAward;this.oldFullyCompleted=stats.fullyCompleted;if(c.timeSpend<=c.currentLevel.goldTime&&stats.timeAward<2){stats.timeAward=2;}
else if(c.timeSpend<=c.currentLevel.silverTime&&stats.timeAward<1){stats.timeAward=1;}
if(c.powerSpend<=c.currentLevel.goldPower&&stats.powerAward<2){stats.powerAward=2;}
else if(c.powerSpend<=c.currentLevel.silverPower&&stats.powerAward<1){stats.powerAward=1;}
if((stats.powerAward===2||!c.currentLevel.goldPower)&&(stats.timeAward===2||!c.currentLevel.goldTime)){stats.fullyCompleted=true;}
main.saveLocalStorage();this.newPowerAwardLevel=stats.powerAward;this.newTimeAwardLevel=stats.timeAward;this.newFullyCompleted=stats.fullyCompleted;this.show();},show:function(){this.createButtons();this.createCurrentAwards(function(){this.createNewAwards(function(){this.upgradeAwards(function(){this.checkUpgradeToGoldStar(function(){this.enableButtons();})});});});},createButtons:function(){this.buttons=[new MenuButton({bitmap:"UI.BigArrowPrev",mask:"UI.BigArrowPrev",onClick:function(){this.disable();main.storage.selectedFolder=main.levelController.currentLevelEntry.fId;main.storage.selectedLevel=main.levelController.currentLevelEntry.lId;main.levelController.openLevel('levels.js');this.parent.remove();},vars:{x:-80,y:320}}),new MenuButton({bitmap:"UI.BigArrowRestart",mask:"UI.BigArrowRestart",onClick:function(){this.disable();main.levelController.resetLevel();this.parent.remove();},vars:{x:0,y:320}}),new MenuButton({bitmap:"UI.BigArrowNext",mask:"UI.BigArrowNext",onClick:function(){this.disable();this.parent.onNext();this.parent.remove();},vars:{x:80,y:320}}),];this.addChildren.apply(this,this.buttons);this.buttons.forEach(function(){this.disable();this.widthScale=0.5;this.opacity=0;});},enableButtons:function(){this.buttons.forEach(function(){this.enable();this.animate({opacity:1,widthScale:1},{duration:500});});},createCurrentAwards:function(callback){if(!this.justCompleted){this.completionAward=new View.Sprite('Menu.BigStar'+(this.oldFullyCompleted?'Gold':'Silver'),0,200,0,{opacity:0});this.completionAward.animate({opacity:1},{duration:1000});this.addChildren(this.completionAward);this.awardCountCurrent++;}
if(this.oldPowerAwardLevel>0&&!this.oldFullyCompleted){this.powerAward=new View.Sprite('Menu.BigPower'+(this.oldPowerAwardLevel>1?'Gold':'Silver'),-this.awardSpacing,200,0,{opacity:0,offset:new Math.Vector(82.5,42)});this.powerAward.animate({opacity:1},{duration:1000});this.addChildren(this.powerAward);}
if(this.oldTimeAwardLevel>0&&!this.oldFullyCompleted){this.timeAward=new View.Sprite('Menu.BigClock'+(this.oldTimeAwardLevel>1?'Gold':'Silver'),this.awardSpacing,200,0,{opacity:0});this.timeAward.animate({opacity:1},{duration:1000});this.addChildren(this.timeAward);}
this.schedule(callback,1000);},createNewAwards:function(callback){if(this.justCompleted===false&&this.oldPowerAwardLevel===this.newPowerAwardLevel&&this.oldTimeAwardLevel===this.newTimeAwardLevel){callback.call(this);return;}
var addQueue;addQueue=[];if(this.justCompleted){addQueue.push('Star'+(this.newFullyCompleted&&this.newPowerAwardLevel===0&&this.newTimeAwardLevel===0?'Gold':'Silver'));}
if(this.oldPowerAwardLevel===0&&this.newPowerAwardLevel>0){addQueue.push('Power'+(this.newPowerAwardLevel===1?'Silver':'Gold'));}
if(this.oldTimeAwardLevel===0&&this.newTimeAwardLevel>0){addQueue.push('Clock'+(this.newTimeAwardLevel===1?'Silver':'Gold'));}
this.processNewAwards(addQueue,callback);},processNewAwards:function(queue,callback){if(queue.length===0){callback.call(this);return;}
addEntry=queue.shift();switch(addEntry.match(/^(Star|Power|Clock)/)[1]){case'Star':this.completionAward=new View.Sprite('Menu.Big'+addEntry,0,200,0,{size:0});this.completionAward.animate({size:1},{duration:1000});this.addChildren(this.completionAward);break;case'Power':this.powerAward=new View.Sprite('Menu.Big'+addEntry,-this.awardSpacing,200,0,{size:0,offset:new Math.Vector(82.5,42)});this.powerAward.animate({size:1},{duration:1000});this.insertBelow(this.powerAward,this.completionAward);break;case'Clock':this.timeAward=new View.Sprite('Menu.Big'+addEntry,this.awardSpacing,200,0,{size:0});this.timeAward.animate({size:1},{duration:1000});this.insertBelow(this.timeAward,this.completionAward);break;}
this.schedule(function(){main.levelController.completionScreen.processNewAwards(queue,callback);},1000);},upgradeAwards:function(callback){if(this.oldPowerAwardLevel+this.newPowerAwardLevel!==3&&this.oldTimeAwardLevel+this.newTimeAwardLevel!==3){callback.call(this);return;}
if(this.oldPowerAwardLevel===1&&this.newPowerAwardLevel===2){this.powerAward.animate({widthScale:0},{duration:500,callback:function(){this.setSource('Menu.BigPowerGold');this.animate({widthScale:1},{duration:500});}});}
if(this.oldTimeAwardLevel===1&&this.newTimeAwardLevel===2){this.timeAward.animate({widthScale:0},{duration:500,callback:function(){this.setSource('Menu.BigClockGold');this.animate({widthScale:1},{duration:500});}});}
this.schedule(function(){callback.call(this);},1000);},checkUpgradeToGoldStar:function(callback){if(this.newPowerAwardLevel!==2||this.newTimeAwardLevel!==2||this.oldTimeAwardLevel+this.oldPowerAwardLevel===4){callback.call(this);return;}
this.powerAward.animate({x:0},{duration:500,easing:'quadIn'});this.timeAward.animate({x:0},{duration:500,easing:'quadIn'});this.schedule(function(){var oldStar;oldStar=this.completionAward;this.completionAward=new View.Sprite('Menu.BigStarGold',0,200,0,{size:0.5});this.completionAward.animate({size:1},{duration:500});this.insertBelow(this.completionAward,oldStar);[oldStar,this.powerAward,this.timeAward].forEach(function(){this.animate({size:1.3,opacity:0},{duration:500,easing:'quadOut',callback:function(){engine.purge(this);}});});},500);this.schedule(callback,1000);},remove:function(){this.children.forEach(function(){if(this.disable){this.disable();}
this.animate({opacity:0},{duration:400});});this.schedule(function(){engine.purge(this);},500);}});new Class('Tutorial',[View.Sprite],{Tutorial:function(type){this.Sprite(type.background,400,184);main.paused=true;main.restartButton.animate({opacity:0.5},{duration:400,loop:engine.currentRoom.loops.eachFrame});main.backButton.animate({opacity:0.5},{duration:400,loop:engine.currentRoom.loops.eachFrame});this.onFinished=type.onFinished||function(){};this.addChildren(this.cover1=new View.Sprite('Tutorials.Cover1',-217,0),this.cover2=new View.Sprite('Tutorials.Cover2',0,0),this.cover3=new View.Sprite('Tutorials.Cover3',217,0),this.text=new View.TextBlock(type.text,0,-3,400,{offset:OFFSET_MIDDLE_CENTER,alignment:ALIGNMENT_CENTER,font:'bold 60px Verdana, sans-serif',color:'#FFF'}),this.nextButton=new MenuButton({bitmap:'UI.MediumArrowNext',mask:'UI.MediumArrowNext',loop:engine.currentRoom.loops.onPaused,onClick:function(){this.parent.showNext();},vars:{x:0,y:130}}));this.children.concat(this).forEach(function(){this.opacity=0;this.animate({opacity:1},{duration:400});});this.progress=0;},showNext:function(){if(this.progress<3){if(this.text.opacity!==0){this.text.animate({opacity:0},{duration:300});}
this.nextButton.disable();this['cover'+(this.progress+1)].animate({opacity:0},{duration:300,callback:function(){this.parent.progress++;this.parent.nextButton.enable();}});}
else{this.remove();}},remove:function(){this.children.concat(this).forEach(function(){if(this.disable){this.disable();}
this.animate({opacity:0},{duration:400});});this.schedule(function(){engine.purge(this);main.paused=false;main.restartButton.animate({opacity:1},{duration:400});main.backButton.animate({opacity:1},{duration:400});this.onFinished();},500);}});objectTypes={Ball:{class:'Ball',depth:0,bitmap:'Objects.Ball',offsetX:26,offsetY:26,offsetLvlX:26,offsetLvlY:26,},Grass:{class:'Obstacle',bitmap:'Objects.Grass',mask:'Masks.Grass',group:'obstacles',depth:3,offsetX:32,offsetY:7,offsetLvlX:32,offsetLvlY:7},GrassUpHill:{class:'Obstacle',bitmap:'Objects.GrassUpHill',mask:'Masks.GrassUpHill',group:'obstacles',depth:3,offsetX:32,offsetY:78,offsetLvlX:32,offsetLvlY:78},GrassDownHill:{class:'Obstacle',bitmap:'Objects.GrassDownHill',mask:'Masks.GrassDownHill',group:'obstacles',depth:3,offsetX:32,offsetY:78,offsetLvlX:32,offsetLvlY:78},Lian:{class:'Obstacle',bitmap:'Objects.Lian',mask:'Objects.Lian',group:'obstacles',depth:1,offsetX:40,offsetY:108,offsetLvlX:40,offsetLvlY:108},Bush:{class:'Obstacle',bitmap:'Objects.Bush',mask:'Objects.Bush',group:'obstacles',depth:2,offsetX:63,offsetY:57,offsetLvlX:63,offsetLvlY:57},Spikes:{class:'Obstacle',bitmap:'Objects.Spikes',mask:'Objects.Spikes',group:'deadlies',depth:4,offsetX:20,offsetY:20,offsetLvlX:20,offsetLvlY:20},Destination:{class:'Obstacle',bitmap:'Objects.Destination',mask:'Objects.Destination',group:'destinations',depth:1,offsetX:34,offsetY:42,offsetLvlX:34,offsetLvlY:42},Trampoline:{class:'Controller',bitmap:'Objects.Trampoline',mask:'Objects.Trampoline',offsetX:47,offsetY:12,offsetLvlX:47,offsetLvlY:12,group:'controllers',depth:1,canControl:function(object){return object.implements(Ball);},doControl:function(object){var peakTime,maxSpeed;if(object.speed.y>0&&Math.abs(object.x-this.x)<32){object.speed.y*=-1.1;maxSpeed=-Math.sqrt(2*main.gravity*(object.y-30));object.speed.y=Math.max(maxSpeed,object.speed.y);}}},TurnHV:{class:'Controller',bitmap:'Objects.Controller',mask:'Controllers.Mask',opacity:0,offsetX:8,offsetY:8,offsetLvlX:8,offsetLvlY:8,group:'controllers',canControl:function(object){return object.implements(Hedgehog);},doControl:function(object){if((this.x-object.x)*object.speed.x<0){return;}
var oldSpeed,oldAnimationSpeed;object.speed.x=-object.speed.x;object.speed.y=-object.speed.y;object.y+=engine.convertSpeed(object.speed.y);oldAnimationSpeed=this.animationSpeed;object.animationSpeed=0;if(object.source==='Objects.Hedgehog'){engine.currentRoom.loops.onRunning.detachFunction(object,object.doMovement);object.animate({widthScale:-object.widthScale},{duration:400,callback:function(){this.animationSpeed=oldAnimationSpeed;engine.currentRoom.loops.onRunning.attachFunction(this,this.doMovement);}});}}},Teleport:{class:'Controller',bitmap:'Objects.TeleIn',mask:'Masks.Tele',offsetX:32,offsetY:32,offsetLvlX:32,offsetLvlY:32,group:'controllers',depth:0,canControl:function(object){return object.implements(Ball);},doControl:function(object){var i,dist,tele;if(object.dead){return;}
if(this.destination){dist=this.getDistanceTo(object);object.stopAnimations();object.opacity=Math.max(0,(dist-15)/30);if(dist<15){for(i=0;i<main.levelController.controllers.length;i++){tele=main.levelController.controllers[i];if(tele.name===this.destination){object.moveTo(tele.x,tele.y);break;}}}
object.animate({opacity:1},{duration:400});}}},Power:{class:'Controller',bitmap:'Powerups.Power',mask:'Masks.Power',offsetX:22,offsetY:22,offsetLvlX:22,offsetLvlY:22,group:'controllers',depth:0,canControl:function(object){return object.implements(Ball);},doControl:function(object){if(object.power<object.powerMax&&this.power>0){this.power-=engine.convertSpeed(60);object.power=Math.min(object.powerMax,object.power+engine.convertSpeed(60));object.updatePower();if(this.power<0){this.animate({heightScale:4,opacity:0},{duration:200,callback:function(){engine.purge(this);}});}
else{this.direction=(1-this.power/this.powerMax)*Math.PI/2;}}}},Hedgehog:{class:'Hedgehog',bitmap:'Objects.Hedgehog',mask:'Objects.Hedgehog',group:'deadlies',depth:0,offsetX:38,offsetY:27,offsetLvlX:38,offsetLvlY:27,initSpeedX:100,initSpeedY:0},HedgehogClimbing:{class:'Hedgehog',bitmap:'Objects.HedgehogHanging',mask:'Objects.HedgehogHanging',group:'deadlies',depth:0,offsetX:21,offsetY:34,offsetLvlX:21,offsetLvlY:34,initSpeedX:0,initSpeedY:100},HedgehogSwinging:{class:'Hedgehog',bitmap:'Objects.HedgehogHanging',mask:'Objects.HedgehogHanging',group:'deadlies',depth:0,offsetX:20,offsetY:-105,offsetLvlX:20,offsetLvlY:-105,initSpeedX:0,initSpeedY:0},};tutorials={movement:{text:'Movement',background:'Tutorials.Movement',onFinished:function(){var text,check;main.levelController.destCopy=main.levelController.destinations;main.levelController.destinations=[];text=new View.TextBlock('Now try moving the ball around',400,200,400,{opacity:0,lineHeight:60,offset:OFFSET_MIDDLE_CENTER,alignment:ALIGNMENT_CENTER,font:'bold 60px Verdana, sans-serif',color:'#e75b35'}),text.animate({opacity:1},{duration:300});tutorialView.addChildren(text);check=function(){if(main.levelController.powerSpend>100){engine.currentRoom.loops.onRunning.detachFunction(this,check);text.animate({opacity:0},{duration:200,callback:function(){engine.purge(this);}});text=new View.TextBlock('Great job!',400,200,400,{opacity:0,lineHeight:60,offset:OFFSET_MIDDLE_CENTER,alignment:ALIGNMENT_CENTER,font:'bold 60px Verdana, sans-serif',color:'#e75b35'}),text.animate({opacity:1},{duration:200});tutorialView.addChildren(text);engine.currentRoom.loops.onRunning.schedule(main.levelController,function(){text.animate({opacity:0},{duration:300,callback:function(){engine.purge(this);}});tutorialView.addChildren(new Tutorial(tutorials.winning));},2000);}}
engine.currentRoom.loops.onRunning.attachFunction(main.levelController.ball,check);}},winning:{text:'Winning',background:'Tutorials.Winning',onFinished:function(){var text,goal;text=new View.TextBlock('Now hit the goal sign to advance to next level',400,200,400,{opacity:0,lineHeight:60,offset:OFFSET_MIDDLE_CENTER,alignment:ALIGNMENT_CENTER,font:'bold 60px Verdana, sans-serif',color:'#e75b35'}),text.animate({opacity:1},{duration:300});tutorialView.addChildren(text);engine.currentRoom.loops.onRunning.schedule(main.levelController,function(){text.animate({opacity:0},{duration:1000,callback:function(){engine.purge(this);}});goal=new Obstacle({"vars":{"offset":{"x":34,"y":42},"opacity":0,"x":800,"y":352},"class":"Obstacle","bitmap":"Objects.Destination","mask":"Objects.Destination","group":"destinations","depth":1});goal.animate({opacity:1},{duration:1000});main.levelController.destinations.push(goal);main.depths[1].addChildren(goal);},3000);},},platforms:{text:'Platforms',background:'Tutorials.Platforms',onFinished:function(){var text,goal;text=new View.TextBlock('Now hit the goal sign to advance to next level',400,200,400,{opacity:0,lineHeight:60,offset:OFFSET_MIDDLE_CENTER,alignment:ALIGNMENT_CENTER,font:'bold 60px Verdana, sans-serif',color:'#e75b35'}),text.animate({opacity:1},{duration:300});tutorialView.addChildren(text);engine.currentRoom.loops.onRunning.schedule(main.levelController,function(){text.animate({opacity:0},{duration:1000,callback:function(){engine.purge(this);}});},3000);},},spikes:{text:'Threats',background:'Tutorials.Spikes',onFinished:function(){var text,goal;text=new View.TextBlock('Now get the ball safely to the goal sign',400,200,400,{opacity:0,lineHeight:60,offset:OFFSET_MIDDLE_CENTER,alignment:ALIGNMENT_CENTER,font:'bold 60px Verdana, sans-serif',color:'#e75b35'}),text.animate({opacity:1},{duration:300});tutorialView.addChildren(text);engine.currentRoom.loops.onRunning.schedule(main.levelController,function(){text.animate({opacity:0},{duration:1000,callback:function(){engine.purge(this);}});},3000);},},power:{text:'Power',background:'Tutorials.Power',onFinished:function(){var text,goal;text=new View.TextBlock('Now complete the level without running out of power',400,200,400,{opacity:0,lineHeight:60,offset:OFFSET_MIDDLE_CENTER,alignment:ALIGNMENT_CENTER,font:'bold 60px Verdana, sans-serif',color:'#e75b35'}),text.animate({opacity:1},{duration:300});tutorialView.addChildren(text);engine.currentRoom.loops.onRunning.schedule(main.levelController,function(){text.animate({opacity:0},{duration:1000,callback:function(){engine.purge(this);}});},3000);},}}